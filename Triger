from hikka import loader, utils
from telethon.tl.types import Message
import random
import time
import re

@loader.tds
class AutoRPTriggersMod(loader.Module):
    """–ú–æ–¥—É–ª—å –∞–≤—Ç–æ-–†–ü —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ —Å —Ä–µ–∞–∫—Ü–∏—è–º–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    
    strings = {"name": "AutoRPTriggers"}
    
    def __init__(self):
        self.triggers = {
            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            r"(?i)(–ø—Ä–∏–≤–µ—Ç|hello|hi|—Ö–∞–π|–∑–¥–∞—Ä–æ–≤|–∫—É)": ["–ü—Ä–∏–≤–µ—Ç! üëã", "–ó–¥–∞—Ä–æ–≤–∞! üòé", "–ò —Ç–µ–±–µ –ø—Ä–∏–≤–µ—Ç! üéâ", "–ü—Ä–∏–≤–µ—Ç–∏–∫! ‚ú®"],
            r"(?i)(–∫–∞–∫ –¥–µ–ª–∞|how are you|–∫–∞–∫ —Ç—ã)": ["–ù–æ—Ä–º! üëç", "–û—Ç–ª–∏—á–Ω–æ! üòä", "–õ—É—á—à–µ –≤—Å–µ—Ö! üöÄ", "–í—Å—ë —Å—É–ø–µ—Ä! üí´"],
            r"(?i)(—Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏|good night|–Ω–æ—á–∏)": ["–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏! üåô", "–°–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤! üí§", "–î–æ–±—Ä–æ–π –Ω–æ—á–∏! üò¥"],
            
            # –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è
            r"(?i)(–æ–±–Ω—è–ª|–æ–±–Ω—è—Ç—å|hug)": ["üíû {from} –æ–±–Ω–∏–º–∞–µ—Ç {to}", "ü§ó {from} –∫—Ä–µ–ø–∫–æ –æ–±–Ω–∏–º–∞–µ—Ç {to}", "ü´Ç {from} –æ–±–Ω–∏–º–∞–µ—Ç {to}"],
            r"(?i)(—É–¥–∞—Ä–∏–ª|—É–¥–∞—Ä–∏—Ç—å|hit|punch)": ["üëä {from} –±—å–µ—Ç {to}", "ü§ï {from} –Ω–∞–Ω–æ—Å–∏—Ç —É–¥–∞—Ä {to}", "ü•ä {from} —É–¥–∞—Ä—è–µ—Ç {to}"],
            r"(?i)(–ø–æ—Ü–µ–ª–æ–≤–∞–ª|–ø–æ—Ü–µ–ª–æ–≤–∞—Ç—å|kiss)": ["üòò {from} —Ü–µ–ª—É–µ—Ç {to}", "üíã {from} –Ω–µ–∂–Ω–æ —Ü–µ–ª—É–µ—Ç {to}", "üòö {from} —Ü–µ–ª—É–µ—Ç {to}"],
            r"(?i)(–ø–æ–≥–ª–∞–¥–∏–ª|–ø–æ–≥–ª–∞–¥–∏—Ç—å|pat)": ["üêæ {from} –≥–ª–∞–¥–∏—Ç {to}", "‚ú® {from} –Ω–µ–∂–Ω–æ –≥–ª–∞–¥–∏—Ç {to}", "üëê {from} –≥–ª–∞–¥–∏—Ç {to}"],
            r"(?i)(—É–∫—É—Å–∏–ª|—É–∫—É—Å–∏—Ç—å|bite)": ["üòà {from} –∫—É—Å–∞–µ—Ç {to}", "ü¶∑ {from} –±–æ–ª—å–Ω–æ –∫—É—Å–∞–µ—Ç {to}", "üê∫ {from} –∫—É—Å–∞–µ—Ç {to}"],
            r"(?i)(–≤—ã–ø–∏–ª|–≤—ã–ø–∏—Ç—å|drink)": ["üç∑ {from} –ø—å–µ—Ç —Å {to}", "üçª {from} –≤—ã–ø–∏–≤–∞–µ—Ç –∑–∞ –∑–¥–æ—Ä–æ–≤—å–µ {to}", "ü•Ç {from} –ø—å–µ—Ç —Å {to}"],
            
            # –≠–º–æ—Ü–∏–∏
            r"(?i)(—Å–º–µ—Ö|—Å–º–µ—à–Ω–æ|—Ö–∞-—Ö–∞|lol)": ["üòÇ –°–º–µ—à–Ω–æ!", "ü§£ –£–º–æ—Ä–∞!", "üòÜ –•–∞-—Ö–∞!"],
            r"(?i)(–≥—Ä—É—Å—Ç–Ω–æ|sad|–ø–µ—á–∞–ª—å)": ["üò¢ –ù–µ –≥—Ä—É—Å—Ç–∏!", "ü§ó –û–±–Ω–∏–º—É!", "‚òπÔ∏è –í—Å—ë –Ω–∞–ª–∞–¥–∏—Ç—Å—è!"],
            r"(?i)(–∑–ª–æ–π|–∑–ª—é—Å—å|angry)": ["üò† –£—Å–ø–æ–∫–æ–π—Å—è!", "üëä –†–∞—Å—Å–ª–∞–±—å—Å—è!", "ü§¨ –ù–µ –∑–ª–∏—Å—å!"],
            
            # –í–æ–ø—Ä–æ—Å—ã
            r"(?i)(–∫–∞–∫ –∂–∏–∑–Ω—å|how life|—á–µ–≥–æ –∫–∞–∫)": ["–ñ–∏–∑–Ω—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞! üåà", "–í—Å—ë –ø—É—á–∫–æ–º! üëç", "–û—Ç–ª–∏—á–Ω–æ! üöÄ"],
            r"(?i)(—á—Ç–æ –¥–µ–ª–∞–µ—à—å|what doing|—á–µ–º –∑–∞–Ω—è—Ç)": ["–û—Ç–≤–µ—á–∞—é –≤ —á–∞—Ç–µ! üí¨", "–û–±—â–∞—é—Å—å —Å —Ç–æ–±–æ–π! üòä", "–†–∞–±–æ—Ç–∞—é! üíª"],
            
            # –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã
            r"(?i)(–∫—Ä–∞—Å–∏–≤—ã–π|–∫—Ä–∞—Å–∏–≤–∞—è|handsome)": ["–°–∞–º—ã–π –∫—Ä–∞—Å–∏–≤—ã–π! üòç", "–û—á–µ–Ω—å –∫—Ä–∞—Å–∏–≤–æ! üíñ", "–ü—Ä–µ–ª–µ—Å—Ç—å! ‚ú®"],
            r"(?i)(—É–º–Ω—ã–π|—É–º–Ω–∞—è|smart)": ["–û—á–µ–Ω—å —É–º–Ω–æ! üß†", "–ì–µ–Ω–∏–∞–ª—å–Ω–æ! üí°", "–£–º–Ω–∏—Ü–∞! üåü"],
            
            # –ï–¥–∞
            r"(?i)(–≤–∫—É—Å–Ω–æ|–≤–∫—É—Å–Ω—ã–π|yummy)": ["üçï –í–∫—É—Å–Ω—è—Ç–∏–Ω–∞!", "üçî –ê–ø–ø–µ—Ç–∏—Ç–Ω–æ!", "üç∞ –í–∫—É—Å–Ω–æ!"],
            r"(?i)(–≥–æ–ª–æ–¥–µ–Ω|–≥–æ–ª–æ–¥–Ω–∞|hungry)": ["üçñ –ü–æ–µ—à—å!", "üçú –ü–µ—Ä–µ–∫—É—Å–∏!", "ü•ò –ü–æ—Ä–∞ –∫—É—à–∞—Ç—å!"],
            
            # –í—Ä–µ–º—è
            r"(?i)(–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ|good morning|—É—Ç—Ä–∞)": ["‚òÄÔ∏è –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!", "üåÖ –£—Ç—Ä–∞ –¥–æ–±—Ä–æ–≥–æ!", "üåû –ü—Ä–∏–≤–µ—Ç!"],
            r"(?i)(–¥–æ–±—Ä—ã–π –¥–µ–Ω—å|good afternoon|–¥–Ω—è)": ["üåá –î–æ–±—Ä—ã–π –¥–µ–Ω—å!", "üåû –ü—Ä–∏–≤–µ—Ç!", "üíº –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π!"],
            r"(?i)(–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä|good evening|–≤–µ—á–µ—Ä–∞)": ["üåÜ –î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!", "üåÉ –ü—Ä–∏–≤–µ—Ç!", "üéá –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π!"],
            
            # –ü—Ä–æ—â–∞–Ω–∏—è
            r"(?i)(–ø–æ–∫–∞|bye|–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è)": ["üëã –ü–æ–∫–∞!", "üòä –î–æ –≤—Å—Ç—Ä–µ—á–∏!", "üåü –£–≤–∏–¥–∏–º—Å—è!"],
            
            # –ò–≥—Ä—ã
            r"(?i)(–∏–≥—Ä–∞—Ç—å|play|game)": ["üéÆ –í–æ —á—Ç–æ –∏–≥—Ä–∞–µ–º?", "üïπÔ∏è –î–∞–≤–∞–π –∏–≥—Ä–∞—Ç—å!", "üëæ –ò–≥—Ä–æ–≤–æ–π —Ä–µ–∂–∏–º!"],
            
            # –ú—É–∑—ã–∫–∞
            r"(?i)(–º—É–∑—ã–∫–∞|music|–ø–µ—Å–Ω—è)": ["üéµ –í–∫–ª—é—á–∞—é –º—É–∑—ã–∫—É!", "üé∂ –õ—é–±–∏–º—ã–π —Ç—Ä–µ–∫?", "üéß –°–ª—É—à–∞–µ–º!"],
            
            # –ü–æ–≥–æ–¥–∞
            r"(?i)(–ø–æ–≥–æ–¥–∞|weather|–¥–æ–∂–¥—å)": ["üåû –°–æ–ª–Ω–µ—á–Ω–æ!", "üåßÔ∏è –î–æ–∂–¥–∏–∫!", "‚ùÑÔ∏è –°–Ω–µ–∂–æ–∫!"],
            
            # –õ—é–±–æ–≤—å
            r"(?i)(–ª—é–±–ª—é|love|–æ–±–æ–∂–∞—é)": ["üíñ –ò —è —Ç–µ–±—è!", "üòç –í–∑–∞–∏–º–Ω–æ!", "üíò –õ—é–±–ª—é!"],
            
            # –°–ø–∞–º
            r"(?i)(—Å–ø–∞–º|spam|—Ñ–ª—É–¥)": ["üö´ –ù–µ—Ç —Å–ø–∞–º—É!", "‚õî –°—Ç–æ–ø —Ñ–ª—É–¥!", "üîá –¢–∏—à–µ!"],
        }
        self.cooldowns = {}
        self.user_cooldowns = {}
        
    async def client_ready(self, client, db):
        self._db = db
        self._client = client
        self.settings = self._db.get("AutoRPTriggers", "settings", {
            "global_cooldown": 10,
            "user_cooldown": 30,
            "enabled": True,
            "probability": 80
        })
    
    async def rptogglecmd(self, message: Message):
        """–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–†–ü: .rptoggle <on/off>"""
        args = utils.get_args_raw(message).lower()
        if args == "on":
            self.settings["enabled"] = True
            await message.edit("‚úÖ –ê–≤—Ç–æ-–†–ü —Ä–µ–∞–∫—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã")
        elif args == "off":
            self.settings["enabled"] = False
            await message.edit("‚ùå –ê–≤—Ç–æ-–†–ü —Ä–µ–∞–∫—Ü–∏–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã")
        else:
            status = "–≤–∫–ª—é—á–µ–Ω—ã" if self.settings["enabled"] else "–≤—ã–∫–ª—é—á–µ–Ω—ã"
            await message.edit(f"üìä –ê–≤—Ç–æ-–†–ü: {status}\n–ò—Å–ø–æ–ª—å–∑—É–π: .rptoggle on/off")
        
        self._db.set("AutoRPTriggers", "settings", self.settings)
    
    async def rpprobcmd(self, message: Message):
        """–ò–∑–º–µ–Ω–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞: .rpprob <1-100>"""
        args = utils.get_args_raw(message)
        if not args.isdigit() or not (1 <= int(args) <= 100):
            return await message.edit("‚ùå –£–∫–∞–∂–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100")
        
        self.settings["probability"] = int(args)
        self._db.set("AutoRPTriggers", "settings", self.settings)
        await message.edit(f"‚úÖ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞: {args}%")
    
    async def rpcooldowncmd(self, message: Message):
        """–ò–∑–º–µ–Ω–∏—Ç—å –∫—É–ª–¥–∞—É–Ω—ã: .rpcooldown <–≥–ª–æ–±–∞–ª—å–Ω—ã–π> <–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π>"""
        args = utils.get_args_raw(message).split()
        if len(args) != 2 or not all(arg.isdigit() for arg in args):
            return await message.edit("‚ùå –§–æ—Ä–º–∞—Ç: .rpcooldown <–≥–ª–æ–±–∞–ª—å–Ω—ã–π> <–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π>")
        
        self.settings["global_cooldown"] = int(args[0])
        self.settings["user_cooldown"] = int(args[1])
        self._db.set("AutoRPTriggers", "settings", self.settings)
        await message.edit(f"‚úÖ –ö—É–ª–¥–∞—É–Ω—ã: –≥–ª–æ–±–∞–ª—å–Ω—ã–π {args[0]}—Å–µ–∫, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π {args[1]}—Å–µ–∫")
    
    async def rplistcmd(self, message: Message):
        """–°–ø–∏—Å–æ–∫ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: .rplist"""
        categories = {}
        for pattern in self.triggers.keys():
            category = pattern.split('|')[0].replace('(?i)(', '').replace(')', '')
            if category not in categories:
                categories[category] = []
            categories[category].append(pattern)
        
        response = "üé≠ –î–æ—Å—Ç—É–ø–Ω—ã–µ –†–ü —Ç—Ä–∏–≥–≥–µ—Ä—ã:\n\n"
        for category, patterns in categories.items():
            response += f"üîπ {category}:\n"
            for pattern in patterns[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 –∏–∑ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                clean_pattern = pattern.replace('(?i)(', '').replace(')', '').split('|')[0]
                response += f"   ‚Ä¢ {clean_pattern}\n"
            if len(patterns) > 3:
                response += f"   ‚Ä¢ ... –∏ –µ—â—ë {len(patterns)-3}\n"
            response += "\n"
        
        await message.edit(response)
    
    async def watcher(self, message: Message):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        if not self.settings["enabled"] or not message.text or message.out:
            return
        
        current_time = time.time()
        chat_id = message.chat_id
        user_id = message.sender_id
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—É–ª–¥–∞—É–Ω–∞
        if chat_id in self.cooldowns and current_time - self.cooldowns[chat_id] < self.settings["global_cooldown"]:
            return
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫—É–ª–¥–∞—É–Ω–∞
        user_key = f"{chat_id}_{user_id}"
        if user_key in self.user_cooldowns and current_time - self.user_cooldowns[user_key] < self.settings["user_cooldown"]:
            return
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
        if random.randint(1, 100) > self.settings["probability"]:
            return
        
        text = message.text.lower()
        
        # –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
        for pattern, responses in self.triggers.items():
            if re.search(pattern, text):
                response = random.choice(responses)
                
                # –ó–∞–º–µ–Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
                if "{from}" in response and "{to}" in response:
                    from_name = await self.get_user_name(user_id)
                    to_name = await self.get_user_name((await message.get_reply_message()).sender_id) if message.is_reply else "–≤—Å–µ—Ö"
                    response = response.format(from=from_name, to=to_name)
                
                # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
                await message.reply(response)
                
                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–æ–≤
                self.cooldowns[chat_id] = current_time
                self.user_cooldowns[user_key] = current_time
                break
    
    async def get_user_name(self, user_id: int):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            user = await self._client.get_entity(user_id)
            return user.first_name or f"user_{user_id}"
        except:
            return f"user_{user_id}"
    
    async def rpaddcmd(self, message: Message):
        """–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π —Ç—Ä–∏–≥–≥–µ—Ä: .rpadd <—Ç—Ä–∏–≥–≥–µ—Ä> <–æ—Ç–≤–µ—Ç>"""
        args = utils.get_args_raw(message)
        if not args or ' ' not in args:
            return await message.edit("‚ùå –§–æ—Ä–º–∞—Ç: .rpadd <—Ç—Ä–∏–≥–≥–µ—Ä> <–æ—Ç–≤–µ—Ç>")
        
        trigger, response = args.split(' ', 1)
        trigger_pattern = f"(?i)({trigger.lower()})"
        
        if trigger_pattern in self.triggers:
            self.triggers[trigger_pattern].append(response)
        else:
            self.triggers[trigger_pattern] = [response]
        
        await message.edit(f"‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω: {trigger} ‚Üí {response}")
    
    async def rpstatcmd(self, message: Message):
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–¥—É–ª—è: .rpstat"""
        total_triggers = sum(len(responses) for responses in self.triggers.values())
        await message.edit(
            f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –†–ü –º–æ–¥—É–ª—è:\n"
            f"‚Ä¢ –í—Å–µ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: {total_triggers}\n"
            f"‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏–π: {len(self.triggers)}\n"
            f"‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: {self.settings['probability']}%\n"
            f"‚Ä¢ –°—Ç–∞—Ç—É—Å: {'–í–ö–õ' if self.settings['enabled'] else '–í–´–ö–õ'}\n"
            f"‚Ä¢ –ì–ª–æ–±–∞–ª—å–Ω—ã–π CD: {self.settings['global_cooldown']}—Å–µ–∫\n"
            f"‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π CD: {self.settings['user_cooldown']}—Å–µ–∫"
        )
