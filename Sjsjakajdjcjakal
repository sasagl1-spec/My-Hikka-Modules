# -*- coding: utf-8 -*-
# –ú–æ–¥—É–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
# –û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–´–ô –ü–†–ò–ú–ï–† - —Ç–æ–ª—å–∫–æ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ü–µ–ª–µ–π

from .. import loader, utils
import asyncio
import random
import logging
from datetime import datetime, timedelta

logger = logging.getLogger(__name__)

@loader.tds
class OptimizedTesterModule(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
    
    strings = {
        "name": "OptimizedTester",
        "active": "‚ö° –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ï–ñ–ò–ú –ê–ö–¢–ò–í–ï–ù",
        "inactive": "‚èπÔ∏è –†–µ–∂–∏–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω",
        "starting": "üöÄ –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞...",
        "warning": "‚ö†Ô∏è –†–ï–ñ–ò–ú –° –£–ú–ï–ù–¨–®–ï–ù–ù–´–ú –†–ò–°–ö–û–ú"
    }

    def __init__(self):
        self.is_running = False
        self.task = None
        self.cycle_count = 0
        self.success_count = 0
        self.fail_count = 0
        self.start_time = None
        self.last_send_time = None
        
        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.all_target_chats = [
            # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–∞—Ç—ã
            "https://t.me/piteraq",
            "https://t.me/vpiskavipspb",
            "https://t.me/VpISkA991", 
            "https://t.me/sextimeeeeeee",
            "https://t.me/vpiski_ekat",
            "https://t.me/tusovkimscspb",
            "https://t.me/vpiski_spb_piter_znakomstva",
            "https://t.me/vpiskimsksspb",
            "https://t.me/chat_berdjansk",
            "https://t.me/chatikiip",
            "https://t.me/vpisk_moskova",
            "https://t.me/moskva_vpiskip",
            "https://t.me/Moskvavispka",
            "https://t.me/vpiska_chelyaba001",
            "https://t.me/vpiskaa_spb",
            "https://t.me/vpiska_beseda",
            
            # –ù–æ–≤—ã–µ —á–∞—Ç—ã
            "https://t.me/MOSCOW_VPISKI_TOP",
            "https://t.me/wpiska_moscow",
            "https://t.me/vpiski_msk99",
            "https://t.me/msvpis",
            "https://t.me/vpiski_Moskow1", 
            "https://t.me/VAO_v_piska",
            "https://t.me/vpiskimsk77"
        ]
        
        # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        self.target_chats = list(dict.fromkeys(self.all_target_chats))
        
        # –¢–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.test_message = "–≠—Å–∫–æ—Ä—Ç —É—Å–ª—É–≥–∏ —É –º–µ–Ω—è –≤ –ø—Ä–æ—Ñ–∏–ª–µü§§ \n–î–µ–≤—É—à–∫–∏ –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Åüíå"
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∞—Ç–∞–º
        self.chat_stats = {}

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info(f"–ú–æ–¥—É–ª—å OptimizedTester –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ß–∞—Ç–æ–≤: {len(self.target_chats)}")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —á–∞—Ç–∞–º
        for chat in self.target_chats:
            self.chat_stats[chat] = {"success": 0, "fails": 0, "last_send": None}

    async def ot_startcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: .ot_start"""
        if self.is_running:
            await utils.answer(message, "üîÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ")
            return
            
        self.is_running = True
        self.start_time = datetime.now()
        self.cycle_count = 0
        
        info_msg = (
            f"{self.strings['starting']}\n\n"
            f"üìä –ù–ê–°–¢–†–û–ô–ö–ò –†–ï–ñ–ò–ú–ê:\n"
            f"‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ü–∏–∫–ª–æ–≤: 70 —Å–µ–∫—É–Ω–¥\n"
            f"‚Ä¢ –ß–∞—Ç–æ–≤ –∑–∞ —Ü–∏–∫–ª: 3\n" 
            f"‚Ä¢ –ü–∞—É–∑–∞ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏: 5 —Å–µ–∫—É–Ω–¥\n"
            f"‚Ä¢ –í—Å–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Ç–æ–≤: {len(self.target_chats)}\n"
            f"‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ü–∏–∫–ª: ~80 —Å–µ–∫—É–Ω–¥\n\n"
            f"‚ÑπÔ∏è –≠—Ç–æ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º —Å –ø–æ–Ω–∏–∂–µ–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π"
        )
        
        await utils.answer(message, info_msg)
        
        # –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
        self.task = asyncio.create_task(self.optimized_testing_loop())
        
        await utils.answer(message, self.strings["active"])
        logger.info(f"–ó–∞–ø—É—â–µ–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –≤ {self.start_time}")

    async def ot_stopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: .ot_stop"""
        if not self.is_running:
            await utils.answer(message, "‚ÑπÔ∏è –†–µ–∂–∏–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω")
            return
            
        self.is_running = False
        if self.task:
            self.task.cancel()
            try:
                await self.task
            except asyncio.CancelledError:
                pass
        
        if self.start_time:
            duration = datetime.now() - self.start_time
            efficiency = self._calculate_efficiency()
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ–ø-—á–∞—Ç–∞–º
            top_chats = self._get_top_chats(5)
            
            stop_msg = (
                f"{self.strings['inactive']}\n\n"
                f"üìà –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n"
                f"‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ —Ü–∏–∫–ª–æ–≤: {self.cycle_count}\n"
                f"‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫: {self.success_count}\n"
                f"‚Ä¢ –ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: {self.fail_count}\n"
                f"‚Ä¢ –û–±—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {efficiency}%\n"
                f"‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: {self._format_duration(duration)}\n"
                f"‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ü–∏–∫–ª–∞: {self._calculate_avg_cycle_time()} —Å–µ–∫\n\n"
                f"üèÜ –¢–û–ü-5 –ß–ê–¢–û–í –ü–û –£–°–ü–ï–®–ù–û–°–¢–ò:\n{top_chats}"
            )
        else:
            stop_msg = self.strings['inactive']
            
        await utils.answer(message, stop_msg)
        logger.info(f"–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –¶–∏–∫–ª–æ–≤: {self.cycle_count}")

    async def optimized_testing_loop(self):
        """–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –¶–ò–ö–õ: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∂–¥—ã–µ 70 —Å–µ–∫—É–Ω–¥ –≤ 3 —á–∞—Ç–∞ —Å –ø–∞—É–∑–æ–π 5 —Å–µ–∫—É–Ω–¥"""
        logger.info("=== –ó–ê–ü–£–©–ï–ù –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –¢–ï–°–¢–ò–†–û–í–ê–í–©–ò–ô –¶–ò–ö–õ ===")
        
        while self.is_running:
            self.cycle_count += 1
            cycle_start_time = datetime.now()
            
            try:
                # –û–°–ù–û–í–ù–ê–Ø –ó–ê–î–ï–†–ñ–ö–ê –ú–ï–ñ–î–£ –¶–ò–ö–õ–ê–ú–ò - 70 –°–ï–ö–£–ù–î
                logger.info(f"–¶–∏–∫–ª #{self.cycle_count} - –û–∂–∏–¥–∞–Ω–∏–µ 70 —Å–µ–∫—É–Ω–¥")
                await asyncio.sleep(70)
                
                if not self.is_running:
                    break
                
                # –í–´–ë–ò–†–ê–ï–ú 3 –°–õ–£–ß–ê–ô–ù–´–• –ß–ê–¢–ê –° –£–ß–ï–¢–û–ú –ò–°–¢–û–†–ò–ò
                selected_chats = self._select_chats_for_cycle(3)
                
                # –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ù–ê–ß–ê–õ–ê –¶–ò–ö–õ–ê
                current_time = datetime.now().strftime('%H:%M:%S')
                logger.info(
                    f"–¶–∏–∫–ª #{self.cycle_count} –Ω–∞—á–∞—Ç –≤ {current_time}\n"
                    f"–í—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã: {', '.join([c.split('/')[-1] for c in selected_chats])}"
                )
                
                # –û–¢–ü–†–ê–í–ö–ê –í 3 –ß–ê–¢–ê –° –ü–ê–£–ó–û–ô 5 –°–ï–ö–£–ù–î
                for i, chat in enumerate(selected_chats):
                    chat_name = chat.split('/')[-1]
                    
                    try:
                        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                        await self.client.send_message(chat, self.test_message)
                        
                        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                        self.success_count += 1
                        self.chat_stats[chat]["success"] += 1
                        self.chat_stats[chat]["last_send"] = datetime.now()
                        self.last_send_time = datetime.now()
                        
                        logger.info(f"–¶–∏–∫–ª #{self.cycle_count}: –£—Å–ø–µ—à–Ω–æ –≤ {chat_name}")
                        
                    except Exception as e:
                        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                        self.fail_count += 1
                        self.chat_stats[chat]["fails"] += 1
                        error_type = str(e)[:100]
                        logger.error(f"–¶–∏–∫–ª #{self.cycle_count}: –û—à–∏–±–∫–∞ –≤ {chat_name}: {error_type}")
                    
                    # –ü–ê–£–ó–ê 5 –°–ï–ö–£–ù–î –ú–ï–ñ–î–£ –û–¢–ü–†–ê–í–ö–ê–ú–ò (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π)
                    if i < len(selected_chats) - 1:
                        await asyncio.sleep(5)
                
                # –†–ê–°–ß–ï–¢ –í–†–ï–ú–ï–ù–ò –í–´–ü–û–õ–ù–ï–ù–ò–Ø –¶–ò–ö–õ–ê
                cycle_duration = (datetime.now() - cycle_start_time).total_seconds()
                logger.info(
                    f"–¶–∏–∫–ª #{self.cycle_count} –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ {cycle_duration:.1f} —Å–µ–∫—É–Ω–¥\n"
                    f"–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ‚úì{self.success_count} ‚úó{self.fail_count}"
                )
                
                # –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø (–∫–∞–∂–¥—ã–µ 10 —Ü–∏–∫–ª–æ–≤)
                if self.cycle_count % 10 == 0:
                    self._perform_maintenance_check()
                
                # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ü–ê–£–ó–ê –ü–†–ò –ü–†–û–ë–õ–ï–ú–ê–•
                if self.fail_count > self.success_count * 0.5 and self.cycle_count > 5:
                    extra_pause = random.randint(120, 300)
                    logger.warning(f"–ú–Ω–æ–≥–æ –æ—à–∏–±–æ–∫! –î–æ–±–∞–≤–æ—á–Ω–∞—è –ø–∞—É–∑–∞ {extra_pause} —Å–µ–∫—É–Ω–¥")
                    await asyncio.sleep(extra_pause)
                    
            except asyncio.CancelledError:
                logger.info("–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–µ—Ä–≤–∞–Ω")
                break
                
            except Exception as e:
                self.fail_count += 1
                logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í –¶–ò–ö–õ–ï #{self.cycle_count}: {e}")
                
                # –ê–í–¢–û–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –° –£–í–ï–õ–ò–ß–ï–ù–ù–û–ô –ü–ê–£–ó–û–ô
                if self.is_running:
                    recovery_delay = random.randint(60, 180)
                    logger.info(f"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {recovery_delay} —Å–µ–∫—É–Ω–¥")
                    await asyncio.sleep(recovery_delay)

    def _select_chats_for_cycle(self, count):
        """–£–º–Ω—ã–π –≤—ã–±–æ—Ä —á–∞—Ç–æ–≤ –¥–ª—è —Ü–∏–∫–ª–∞ —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏"""
        if len(self.target_chats) <= count:
            return self.target_chats.copy()
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —á–∞—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å—Ç–∞—Ä—ã–µ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ)
        sorted_chats = sorted(
            self.target_chats,
            key=lambda x: self.chat_stats[x]["last_send"] or datetime.min
        )
        
        # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ N —á–∞—Ç–æ–≤ (—Ç–µ, —á—Ç–æ –¥–∞–≤–Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π)
        selected = sorted_chats[:count]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ (30% chance –¥–æ–±–∞–≤–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —á–∞—Ç)
        if random.random() < 0.3 and len(sorted_chats) > count:
            random_chat = random.choice(sorted_chats[count:])
            selected[-1] = random_chat  # –ó–∞–º–µ–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π
        
        return selected

    def _perform_maintenance_check(self):
        """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è"""
        efficiency = self._calculate_efficiency()
        active_chats = sum(1 for stats in self.chat_stats.values() if stats["success"] > 0)
        
        logger.info(
            f"=== –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê #{self.cycle_count//10} ===\n"
            f"‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {efficiency}%\n"
            f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤: {active_chats}/{len(self.target_chats)}\n"
            f"‚Ä¢ –°—Ä–µ–¥–Ω—è—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å: {self._calculate_avg_success_rate()}%\n"
            f"‚Ä¢ –¶–∏–∫–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏: {self._count_failed_cycles()}"
        )
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —á–∞—Ç–æ–≤ (–µ—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫)
        if efficiency < 40:
            problem_chats = self._identify_problem_chats()
            if problem_chats:
                logger.warning(f"–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —á–∞—Ç—ã: {len(problem_chats)}")

    async def ot_statscmd(self, message):
        """–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: .ot_stats"""
        if not self.start_time:
            await utils.answer(message, "üì≠ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–æ—Å—å")
            return
            
        current_time = datetime.now()
        duration = current_time - self.start_time
        efficiency = self._calculate_efficiency()
        avg_cycle = self._calculate_avg_cycle_time()
        avg_success = self._calculate_avg_success_rate()
        
        # –†–∞—Å—Å—á–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞)
        risk_assessment = self._assess_risk_level()
        
        stats_text = f"""
üìä –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

‚öôÔ∏è –ü–ê–†–ê–ú–ï–¢–†–´ –†–ï–ñ–ò–ú–ê:
‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏: 70 —Å–µ–∫—É–Ω–¥
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ü–∏–∫–ª: 3
‚Ä¢ –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏: 5 —Å–µ–∫—É–Ω–¥
‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ü–∏–∫–ª: ~80 —Å–µ–∫—É–Ω–¥

üìà –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:
‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ —Ü–∏–∫–ª–æ–≤: {self.cycle_count}
‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫: {self.success_count}
‚Ä¢ –ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: {self.fail_count}
‚Ä¢ –û–±—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {efficiency}%
‚Ä¢ –°—Ä–µ–¥–Ω—è—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —á–∞—Ç–∞: {avg_success}%
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤: {self._count_active_chats()}/{len(self.target_chats)}

‚è±Ô∏è –í–†–ï–ú–ï–ù–ù–´–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: {self._format_duration(duration)}
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ü–∏–∫–ª–∞: {avg_cycle} —Å–µ–∫—É–Ω–¥
‚Ä¢ –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã: {self.start_time.strftime('%H:%M:%S')}
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞: {self.last_send_time.strftime('%H:%M:%S') if self.last_send_time else '–Ω–µ—Ç'}
‚Ä¢ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {current_time.strftime('%H:%M:%S')}

üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ß–ê–¢–û–í:
‚Ä¢ –ß–∞—Ç–æ–≤ —Å —É—Å–ø–µ—à–Ω—ã–º–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏: {self._count_chats_with_success()}
‚Ä¢ –ß–∞—Ç–æ–≤ —Ç–æ–ª—å–∫–æ —Å –æ—à–∏–±–∫–∞–º–∏: {self._count_chats_with_only_fails()}
‚Ä¢ –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤: {self._count_unused_chats()}

{risk_assessment}

‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å: {'üü¢ –ê–ö–¢–ò–í–ï–ù' if self.is_running else 'üî¥ –û–°–¢–ê–ù–û–í–õ–ï–ù'}
        """
        
        await utils.answer(message, stats_text)

    async def ot_chatstatscmd(self, message):
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —á–∞—Ç—É: .ot_chatstats <–Ω–æ–º–µ—Ä –∏–ª–∏ —Å—Å—ã–ª–∫–∞>"""
        args = utils.get_args_raw(message)
        
        if not args:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —á–∞—Ç–∞–º
            chat_list = "\n".join([
                f"{i+1}. {chat.split('/')[-1]:25} ‚úì{stats['success']:3} ‚úó{stats['fails']:3}"
                for i, (chat, stats) in enumerate(list(self.chat_stats.items())[:10])
            ])
            
            if len(self.chat_stats) > 10:
                chat_list += f"\n... –∏ –µ—â–µ {len(self.chat_stats) - 10} —á–∞—Ç–æ–≤"
            
            response = f"üìã –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ß–ê–¢–ê–ú (–ø–µ—Ä–≤—ã–µ 10):\n{chat_list}"
            await utils.answer(message, response)
            return
        
        # –ü–æ–∏—Å–∫ —á–∞—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ —Å—Å—ã–ª–∫–µ
        chat_info = None
        if args.isdigit():
            idx = int(args) - 1
            if 0 <= idx < len(self.target_chats):
                chat = self.target_chats[idx]
                stats = self.chat_stats[chat]
                chat_info = (chat, stats)
        else:
            # –ò—â–µ–º –ø–æ —Å—Å—ã–ª–∫–µ
            for chat, stats in self.chat_stats.items():
                if args in chat:
                    chat_info = (chat, stats)
                    break
        
        if not chat_info:
            await utils.answer(message, "‚ùå –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        
        chat, stats = chat_info
        chat_name = chat.split('/')[-1]
        
        total = stats['success'] + stats['fails']
        success_rate = (stats['success'] / total * 100) if total > 0 else 0
        
        chat_stats_text = f"""
üìä –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ß–ê–¢–ê:

üîó –°—Å—ã–ª–∫–∞: {chat}
üè∑Ô∏è –ò–º—è: {chat_name}

üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–¢–ü–†–ê–í–û–ö:
‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö: {stats['success']}
‚Ä¢ –ù–µ—É–¥–∞—á–Ω—ã—Ö: {stats['fails']}
‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: {total}
‚Ä¢ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {success_rate:.1f}%

üïí –í–†–ï–ú–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï:
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞: {stats['last_send'].strftime('%Y-%m-%d %H:%M:%S') if stats['last_send'] else '–Ω–∏–∫–æ–≥–¥–∞'}
‚Ä¢ –í –æ—á–µ—Ä–µ–¥–∏: {'–î–∞' if stats['last_send'] and (datetime.now() - stats['last_send']).total_seconds() > 3600 else '–ù–µ—Ç'}

üìä –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
‚Ä¢ –í –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ: {self.target_chats.index(chat) + 1}/{len(self.target_chats)}
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏: {'–í—ã—Å–æ–∫–∏–π' if not stats['last_send'] or stats['success'] == 0 else '–°—Ä–µ–¥–Ω–∏–π' if stats['fails'] > stats['success'] else '–ù–∏–∑–∫–∏–π'}
        """
        
        await utils.answer(message, chat_stats_text)

    async def ot_testcyclecmd(self, message):
        """–¢–µ—Å—Ç–æ–≤—ã–π —Ü–∏–∫–ª –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è: .ot_testcycle"""
        try:
            if len(self.target_chats) < 3:
                await utils.answer(message, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —á–∞—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞")
                return
            
            # –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ü–∏–∫–ª
            test_chats = random.sample(self.target_chats, min(3, len(self.target_chats)))
            results = []
            
            for i, chat in enumerate(test_chats):
                chat_name = chat.split('/')[-1]
                
                try:
                    await self.client.send_message(chat, self.test_message)
                    results.append(f"‚úÖ {i+1}. {chat_name}: –£—Å–ø–µ—à–Ω–æ")
                    
                    # –ü–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
                    if i < len(test_chats) - 1:
                        await asyncio.sleep(5)
                        
                except Exception as e:
                    error_msg = str(e)[:50]
                    results.append(f"‚ùå {i+1}. {chat_name}: {error_msg}")
            
            response = "üîß –¢–ï–°–¢–û–í–´–ô –¶–ò–ö–õ:\n\n" + "\n".join(results)
            await utils.answer(message, response)
            
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞: {str(e)}")

    async def ot_pausecmd(self, message):
        """–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞: .ot_pause <–º–∏–Ω—É—Ç—ã>"""
        if not self.is_running:
            await utils.answer(message, "‚ÑπÔ∏è –†–µ–∂–∏–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω")
            return
            
        args = utils.get_args_raw(message)
        
        if not args or not args.isdigit():
            await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø–∞—É–∑—ã –≤ –º–∏–Ω—É—Ç–∞—Ö: .ot_pause 5")
            return
            
        pause_minutes = int(args)
        
        if pause_minutes > 60:
            await utils.answer(message, "‚ö†Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞ - 60 –º–∏–Ω—É—Ç")
            return
        
        pause_seconds = pause_minutes * 60
        
        # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–∏–∫–ª
        was_running = self.is_running
        self.is_running = False
        if self.task:
            self.task.cancel()
        
        await utils.answer(message, f"‚è∏Ô∏è –ü–∞—É–∑–∞ –Ω–∞ {pause_minutes} –º–∏–Ω—É—Ç...")
        await asyncio.sleep(pause_seconds)
        
        # –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
        if was_running:
            self.is_running = True
            self.task = asyncio.create_task(self.optimized_testing_loop())
            await utils.answer(message, f"‚ñ∂Ô∏è –ü–∞—É–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Ä–∞–±–æ—Ç–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞")
        else:
            await utils.answer(message, f"‚ñ∂Ô∏è –ü–∞—É–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")

    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    def _calculate_efficiency(self):
        total = self.success_count + self.fail_count
        return round((self.success_count / total * 100), 1) if total > 0 else 100.0

    def _calculate_avg_cycle_time(self):
        if self.cycle_count == 0 or not self.start_time:
            return 0
        total_seconds = (datetime.now() - self.start_time).total_seconds()
        return round(total_seconds / self.cycle_count, 1)

    def _calculate_avg_success_rate(self):
        if not self.chat_stats:
            return 0
        rates = []
        for stats in self.chat_stats.values():
            total = stats["success"] + stats["fails"]
            if total > 0:
                rates.append(stats["success"] / total * 100)
        return round(sum(rates) / len(rates), 1) if rates else 0

    def _count_active_chats(self):
        return sum(1 for stats in self.chat_stats.values() if stats["success"] > 0)

    def _count_chats_with_success(self):
        return sum(1 for stats in self.chat_stats.values() if stats["success"] > 0)

    def _count_chats_with_only_fails(self):
        return sum(1 for stats in self.chat_stats.values() if stats["fails"] > 0 and stats["success"] == 0)

    def _count_unused_chats(self):
        return sum(1 for stats in self.chat_stats.values() if stats["success"] == 0 and stats["fails"] == 0)

    def _count_failed_cycles(self):
        # –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Ü–∏–∫–ª —Å –æ—à–∏–±–∫–æ–π –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 —Ü–∏–∫–ª–∞—Ö
        return min(self.cycle_count // 3, 10)  # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

    def _identify_problem_chats(self):
        problem_chats = []
        for chat, stats in self.chat_stats.items():
            total = stats["success"] + stats["fails"]
            if total >= 3 and stats["success"] / total < 0.3:
                problem_chats.append(chat.split('/')[-1])
        return problem_chats

    def _get_top_chats(self, count):
        sorted_chats = sorted(
            self.chat_stats.items(),
            key=l
