# -*- coding: utf-8 -*-
# –ü—Ä–æ—Å—Ç–æ–π –º–æ–¥—É–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏

from .. import loader, utils
import asyncio
import random
import logging

logger = logging.getLogger(__name__)

@loader.tds
class SimpleAutoPoster(loader.Module):
    """–ü—Ä–æ—Å—Ç–æ–π –º–æ–¥—É–ª—å –∞–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥–∞"""
    
    strings = {"name": "SimplePoster"}

    def __init__(self):
        self.running = False
        self.task = None
        
        # –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
        self.chats = [
            "https://t.me/piteraq",
            "https://t.me/vpiskavipspb",
            "https://t.me/VpISkA991",
            "https://t.me/sextimeeeeeee",
            "https://t.me/vpiski_ekat",
            "https://t.me/tusovkimscspb",
            "https://t.me/vpiski_spb_piter_znakomstva",
            "https://t.me/vpiskimsksspb",
            "https://t.me/chat_berdjansk",
            "https://t.me/chatikiip",
            "https://t.me/vpisk_moskova",
            "https://t.me/moskva_vpiskip",
            "https://t.me/Moskvavispka",
            "https://t.me/vpiska_chelyaba001",
            "https://t.me/vpiskaa_spb",
            "https://t.me/vpiska_beseda",
            "https://t.me/MOSCOW_VPISKI_TOP",
            "https://t.me/wpiska_moscow",
            "https://t.me/vpiski_msk99",
            "https://t.me/msvpis",
            "https://t.me/vpiski_Moskow1",
            "https://t.me/VAO_v_piska",
            "https://t.me/vpiskimsk77"
        ]
        
        self.message = "–≠—Å–∫–æ—Ä—Ç —É—Å–ª—É–≥–∏ —É –º–µ–Ω—è –≤ –ø—Ä–æ—Ñ–∏–ª–µü§§ \n–î–µ–≤—É—à–∫–∏ –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Åüíå"

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("SimplePoster –∑–∞–≥—Ä—É–∂–µ–Ω")

    async def startcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å: .start"""
        if self.running:
            await utils.answer(message, "–£–∂–µ –∑–∞–ø—É—â–µ–Ω–æ")
            return
        
        self.running = True
        await utils.answer(message, "–ó–∞–ø—É—Å–∫–∞—é...")
        
        self.task = asyncio.create_task(self.main_loop())
        await utils.answer(message, "‚úÖ –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω")

    async def stopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: .stop"""
        if not self.running:
            await utils.answer(message, "–ù–µ –∑–∞–ø—É—â–µ–Ω–æ")
            return
        
        self.running = False
        if self.task:
            self.task.cancel()
        
        await utils.answer(message, "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")

    async def statscmd(self, message):
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: .stats"""
        status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç" if self.running else "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        await utils.answer(message, f"–°—Ç–∞—Ç—É—Å: {status}\n–ß–∞—Ç–æ–≤: {len(self.chats)}")

    async def testcmd(self, message):
        """–¢–µ—Å—Ç: .test"""
        try:
            if len(self.chats) < 3:
                await utils.answer(message, "–ú–∞–ª–æ —á–∞—Ç–æ–≤")
                return
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ 3 —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∞—Ç–∞
            selected = random.sample(self.chats, 3)
            
            for i, chat in enumerate(selected):
                try:
                    await self.client.send_message(chat, self.message)
                    await asyncio.sleep(5)  # –ü–∞—É–∑–∞ 5 —Å–µ–∫
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –≤ {chat}: {e}")
            
            await utils.answer(message, f"–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤: {len(selected)} —á–∞—Ç–æ–≤")
            
        except Exception as e:
            await utils.answer(message, f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: {e}")

    async def main_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª"""
        logger.info("–¶–∏–∫–ª –∑–∞–ø—É—â–µ–Ω")
        
        while self.running:
            try:
                # –ñ–¥–µ–º 70 —Å–µ–∫—É–Ω–¥
                await asyncio.sleep(70)
                
                if not self.running:
                    break
                
                # –í—ã–±–∏—Ä–∞–µ–º 3 —á–∞—Ç–∞
                if len(self.chats) >= 3:
                    selected = random.sample(self.chats, 3)
                else:
                    selected = self.chats
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –ø–∞—É–∑–æ–π 5 —Å–µ–∫—É–Ω–¥
                for i, chat in enumerate(selected):
                    try:
                        await self.client.send_message(chat, self.message)
                        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat}")
                        
                        # –ü–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
                        if i < len(selected) - 1:
                            await asyncio.sleep(5)
                            
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞: {e}")
                        continue
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —Ü–∏–∫–ª–∞: {e}")
                await asyncio.sleep(60)

    async def helpcmd(self, message):
        """–ü–æ–º–æ—â—å: .help"""
        help_text = """
üìã –ö–æ–º–∞–Ω–¥—ã:
‚Ä¢ .start - –∑–∞–ø—É—Å—Ç–∏—Ç—å
‚Ä¢ .stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
‚Ä¢ .stats - —Å—Ç–∞—Ç—É—Å
‚Ä¢ .test - —Ç–µ—Å—Ç
‚Ä¢ .help - –ø–æ–º–æ—â—å

‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª: 70 —Å–µ–∫
‚Ä¢ –ß–∞—Ç–æ–≤ –∑–∞ —Ü–∏–∫–ª: 3
‚Ä¢ –ü–∞—É–∑–∞ –º–µ–∂–¥—É: 5 —Å–µ–∫
        """
        await utils.answer(message, help_text)

    async def on_unload(self):
        if self.running:
            self.running = False
        if self.task:
            self.task.cancel()
        logger.info("–ú–æ–¥—É–ª—å –≤—ã–≥—Ä—É–∂–µ–Ω")
