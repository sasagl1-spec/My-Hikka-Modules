# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/forward-arrow.png
# meta description: –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Ä–µ–ø–ª–∞–µ–≤ –≤ –∫–∞–Ω–∞–ª @manqiin
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class ForwardToManqiin(loader.Module):
    """–ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Ä–µ–ø–ª–∞–µ–≤ –≤ –∫–∞–Ω–∞–ª @manqiin"""
    
    strings = {
        "name": "ForwardManqiin",
        "no_reply": "‚ùå <b>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏</b>",
        "forwarded": "‚úÖ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ @manqiin</b>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞:</b> {}",
        "test": "üîÑ <b>–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ @manqiin</b>",
        "status": "üîÑ <b>–°—Ç–∞—Ç—É—Å:</b> –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –≤ @manqiin –∞–∫—Ç–∏–≤–Ω–∞"
    }
    
    strings_ru = {
        "no_reply": "‚ùå <b>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏</b>",
        "forwarded": "‚úÖ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ @manqiin</b>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞:</b> {}",
        "test": "üîÑ <b>–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ @manqiin</b>",
        "status": "üîÑ <b>–°—Ç–∞—Ç—É—Å:</b> –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –≤ @manqiin –∞–∫—Ç–∏–≤–Ω–∞"
    }
    
    def __init__(self):
        self.target_channel = "@manqiin"
    
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("ForwardToManqiin –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(
        ru_doc="–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Ä–µ–ø–ª–∞–π –≤ @manqiin",
        en_doc="Forward reply to @manqiin"
    )
    async def fwdmcmd(self, message):
        """–ü–µ—Ä–µ—Å–ª–∞—Ç—å –≤ @manqiin"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ø–ª–∞–π
        reply = await message.get_reply_message()
        if not reply:
            await utils.answer(message, self.strings("no_reply"))
            return
        
        try:
            # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            await reply.forward_to(self.target_channel)
            await utils.answer(message, self.strings("forwarded"))
            
            logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ @manqiin (ID: {reply.id})")
            
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
            logger.error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏: {e}")
    
    @loader.command(
        ru_doc="–¢–µ—Å—Ç–æ–≤–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è",
        en_doc="Test forward current message"
    )
    async def fwdmtestcmd(self, message):
        """–¢–µ—Å—Ç –ø–µ—Ä–µ—Å—ã–ª–∫–∏"""
        try:
            await message.forward_to(self.target_channel)
            await utils.answer(message, self.strings("test"))
            logger.info("–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ @manqiin")
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è",
        en_doc="Module status"
    )
    async def fwdmstatuscmd(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        await utils.answer(message, self.strings("status"))
    
    @loader.command(
        ru_doc="–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º <—Ç–µ–∫—Å—Ç>",
        en_doc="Forward with text <text>"
    )
    async def fwdmtextcmd(self, message):
        """–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º <—Ç–µ–∫—Å—Ç>"""
        reply = await message.get_reply_message()
        if not reply:
            await utils.answer(message, self.strings("no_reply"))
            return
        
        text = utils.get_args_raw(message)
        if not text:
            await utils.answer(message, "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è</b>")
            return
        
        try:
            # –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await reply.forward_to(self.target_channel)
            
            # –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            await self.client.send_message(
                self.target_channel,
                f"üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b>\n{text}",
                parse_mode='HTML'
            )
            
            await utils.answer(message, "‚úÖ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ @manqiin</b>")
            logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ @manqiin")
            
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–ü–µ—Ä–µ—Å–ª–∞—Ç—å –º–µ–¥–∏–∞ —Å –ø–æ–¥–ø–∏—Å—å—é",
        en_doc="Forward media with caption"
    )
    async def fwdmmediacmd(self, message):
        """–ü–µ—Ä–µ—Å–ª–∞—Ç—å –º–µ–¥–∏–∞"""
        reply = await message.get_reply_message()
        if not reply:
            await utils.answer(message, self.strings("no_reply"))
            return
        
        if not reply.media:
            await utils.answer(message, "‚ùå <b>–í –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç –º–µ–¥–∏–∞</b>")
            return
        
        try:
            # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –º–µ–¥–∏–∞
            await reply.forward_to(self.target_channel)
            await utils.answer(message, self.strings("forwarded"))
            
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
