# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/text.png
# meta description: –ê–≤—Ç–æ–∑–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ —à–∞–±–ª–æ–Ω–∞–º
# scope: hikka_only
# scope: hikka_min 1.6.0

from .. import loader, utils
import logging
import re

logger = logging.getLogger(__name__)

@loader.tds
class TextReplacerMod(loader.Module):
    """–ê–≤—Ç–æ–∑–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ —à–∞–±–ª–æ–Ω–∞–º"""
    
    strings = {
        "name": "TextReplacer",
        "help": "üìù <b>–ê–≤—Ç–æ–∑–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞</b>\n\n"
                "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
                ".replace <—Ç–µ–∫—Å—Ç> - –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω–∞–º\n"
                ".addtemplate <—à–∞–±–ª–æ–Ω> <–∑–∞–º–µ–Ω–∞> - –¥–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω\n"
                ".templates - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã\n"
                ".removetemplate <–Ω–æ–º–µ—Ä> - —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω\n"
                ".testreplace <—Ç–µ–∫—Å—Ç> - —Ç–µ—Å—Ç –∑–∞–º–µ–Ω—ã\n",
        "replaced": "‚úÖ <b>–¢–µ–∫—Å—Ç –∑–∞–º–µ–Ω–µ–Ω:</b>\n{}",
        "no_text": "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã</b>",
        "template_added": "‚úÖ <b>–®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω:</b>\n<code>{}</code> ‚Üí <code>{}</code>",
        "template_exists": "‚ö†Ô∏è <b>–®–∞–±–ª–æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</b>",
        "templates_list": "üìã <b>–®–∞–±–ª–æ–Ω—ã –∑–∞–º–µ–Ω—ã:</b>\n{}",
        "no_templates": "üì≠ <b>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</b>",
        "template_removed": "üóëÔ∏è <b>–®–∞–±–ª–æ–Ω —É–¥–∞–ª–µ–Ω:</b> {}",
        "invalid_template_num": "‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —à–∞–±–ª–æ–Ω–∞</b>",
        "test_result": "üß™ <b>–¢–µ—Å—Ç –∑–∞–º–µ–Ω—ã:</b>\n"
                       "<b>–ò—Å—Ö–æ–¥–Ω—ã–π:</b> {}\n"
                       "<b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b> {}"
    }
    
    strings_ru = {
        "help": "üìù <b>–ê–≤—Ç–æ–∑–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞</b>\n\n"
                "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
                ".replace <—Ç–µ–∫—Å—Ç> - –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω–∞–º\n"
                ".addtemplate <—à–∞–±–ª–æ–Ω> <–∑–∞–º–µ–Ω–∞> - –¥–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω\n"
                ".templates - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã\n"
                ".removetemplate <–Ω–æ–º–µ—Ä> - —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω\n"
                ".testreplace <—Ç–µ–∫—Å—Ç> - —Ç–µ—Å—Ç –∑–∞–º–µ–Ω—ã\n",
        "replaced": "‚úÖ <b>–¢–µ–∫—Å—Ç –∑–∞–º–µ–Ω–µ–Ω:</b>\n{}",
        "no_text": "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã</b>",
        "template_added": "‚úÖ <b>–®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω:</b>\n<code>{}</code> ‚Üí <code>{}</code>",
        "template_exists": "‚ö†Ô∏è <b>–®–∞–±–ª–æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</b>",
        "templates_list": "üìã <b>–®–∞–±–ª–æ–Ω—ã –∑–∞–º–µ–Ω—ã:</b>\n{}",
        "no_templates": "üì≠ <b>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</b>",
        "template_removed": "üóëÔ∏è <b>–®–∞–±–ª–æ–Ω —É–¥–∞–ª–µ–Ω:</b> {}",
        "invalid_template_num": "‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —à–∞–±–ª–æ–Ω–∞</b>",
        "test_result": "üß™ <b>–¢–µ—Å—Ç –∑–∞–º–µ–Ω—ã:</b>\n"
                       "<b>–ò—Å—Ö–æ–¥–Ω—ã–π:</b> {}\n"
                       "<b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b> {}"
    }
    
    def __init__(self):
        self.templates = []
        self.default_templates = [
            ("—Ä–≤", "+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö"),
            ("—Ä—Ñ", "üá∑üá∫ –†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è"),
            ("—Å–ø—Å", "–°–ø–∞—Å–∏–±–æ!"),
            ("–ø–∂", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞"),
            ("–æ–∫", "–û–∫–µ–π"),
            ("–º–±", "–ú–æ–∂–µ—Ç –±—ã—Ç—å"),
            ("–Ω–≥", "–° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!"),
            ("–¥—Ä", "–° –î–Ω–µ–º –†–æ–∂–¥–µ–Ω–∏—è!"),
        ]
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        self.templates = self.db.get(__name__, "templates", [])
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        if not self.templates:
            self.templates = self.default_templates.copy()
            self._save_templates()
        
        logger.info(f"TextReplacer –∑–∞–≥—Ä—É–∂–µ–Ω, —à–∞–±–ª–æ–Ω–æ–≤: {len(self.templates)}")
    
    @loader.command(
        ru_doc="<—Ç–µ–∫—Å—Ç> - –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω–∞–º",
        en_doc="<text> - Replace text using templates"
    )
    async def replacecmd(self, message):
        """–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç"""
        text = utils.get_args_raw(message)
        
        if not text:
            await utils.answer(message, self.strings("no_text"))
            return
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–º–µ–Ω—É
        replaced_text = self._apply_replacements(text)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await utils.answer(
            message,
            self.strings("replaced").format(replaced_text)
        )
        
        logger.info(f"–¢–µ–∫—Å—Ç –∑–∞–º–µ–Ω–µ–Ω: '{text}' ‚Üí '{replaced_text}'")
    
    @loader.command(
        ru_doc="<—à–∞–±–ª–æ–Ω> <–∑–∞–º–µ–Ω–∞> - –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω –∑–∞–º–µ–Ω—ã",
        en_doc="<pattern> <replacement> - Add replacement template"
    )
    async def addtemplatecmd(self, message):
        """–î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω"""
        args = utils.get_args(message)
        
        if len(args) < 2:
            await utils.answer(
                message,
                "‚ùå <b>–§–æ—Ä–º–∞—Ç:</b> .addtemplate <—à–∞–±–ª–æ–Ω> <–∑–∞–º–µ–Ω–∞>\n"
                "–ü—Ä–∏–º–µ—Ä: .addtemplate —Ä–≤ +79902136543 –ü–°–ë –ë–∞–Ω–∫ –í–∞—Å–∏–ª–∏–π –ö"
            )
            return
        
        pattern = args[0]
        replacement = " ".join(args[1:])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —à–∞–±–ª–æ–Ω
        for existing_pattern, _ in self.templates:
            if existing_pattern == pattern:
                await utils.answer(message, self.strings("template_exists"))
                return
        
        # –î–æ–±–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω
        self.templates.append((pattern, replacement))
        self._save_templates()
        
        await utils.answer(
            message,
            self.strings("template_added").format(pattern, replacement)
        )
        
        logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω —à–∞–±–ª–æ–Ω: '{pattern}' ‚Üí '{replacement}'")
    
    @loader.command(
        ru_doc="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã",
        en_doc="Show all templates"
    )
    async def templatescmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω—ã"""
        if not self.templates:
            await utils.answer(message, self.strings("no_templates"))
            return
        
        templates_text = ""
        for i, (pattern, replacement) in enumerate(self.templates, 1):
            templates_text += f"{i}. <code>{pattern}</code> ‚Üí <code>{replacement}</code>\n"
        
        await utils.answer(
            message,
            self.strings("templates_list").format(templates_text)
        )
    
    @loader.command(
        ru_doc="<–Ω–æ–º–µ—Ä> - –£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω",
        en_doc="<number> - Remove template"
    )
    async def removetemplatecmd(self, message):
        """–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω"""
        args = utils.get_args(message)
        
        if not args:
            await utils.answer(
                message,
                "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —à–∞–±–ª–æ–Ω–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</b>\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .templates —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–º–µ—Ä–∞"
            )
            return
        
        try:
            template_num = int(args[0]) - 1
            
            if 0 <= template_num < len(self.templates):
                removed_pattern, removed_replacement = self.templates.pop(template_num)
                self._save_templates()
                
                await utils.answer(
                    message,
                    self.strings("template_removed").format(
                        f"<code>{removed_pattern}</code> ‚Üí <code>{removed_replacement}</code>"
                    )
                )
                
                logger.info(f"–£–¥–∞–ª–µ–Ω —à–∞–±–ª–æ–Ω: '{removed_pattern}'")
            else:
                await utils.answer(message, self.strings("invalid_template_num"))
                
        except ValueError:
            await utils.answer(message, self.strings("invalid_template_num"))
    
    @loader.command(
        ru_doc="<—Ç–µ–∫—Å—Ç> - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ–Ω—É –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏",
        en_doc="<text> - Test replacement without sending"
    )
    async def testreplacecmd(self, message):
        """–¢–µ—Å—Ç –∑–∞–º–µ–Ω—ã"""
        text = utils.get_args_raw(message)
        
        if not text:
            await utils.answer(message, self.strings("no_text"))
            return
        
        replaced_text = self._apply_replacements(text)
        
        await utils.answer(
            message,
            self.strings("test_result").format(text, replaced_text)
        )
    
    @loader.command(
        ru_doc="–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º —à–∞–±–ª–æ–Ω–∞–º",
        en_doc="Reset to default templates"
    )
    async def resettemplatescmd(self, message):
        """–°–±—Ä–æ—Å–∏—Ç—å —à–∞–±–ª–æ–Ω—ã"""
        self.templates = self.default_templates.copy()
        self._save_templates()
        
        await utils.answer(
            message,
            f"‚úÖ <b>–®–∞–±–ª–æ–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º</b>\n"
            f"–í—Å–µ–≥–æ —à–∞–±–ª–æ–Ω–æ–≤: {len(self.templates)}"
        )
        
        logger.info("–®–∞–±–ª–æ–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º")
    
    @loader.command(
        ru_doc="–î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω —Ä–≤ —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏",
        en_doc="Add —Ä–≤ template with your data"
    )
    async def addrvcmd(self, message):
        """–î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω —Ä–≤"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —à–∞–±–ª–æ–Ω —Ä–≤
        for pattern, _ in self.templates:
            if pattern == "—Ä–≤":
                await utils.answer(
                    message,
                    "‚ö†Ô∏è <b>–®–∞–±–ª–æ–Ω '—Ä–≤' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</b>\n"
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .removetemplate —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞"
                )
                return
        
        # –î–æ–±–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω
        self.templates.insert(0, ("—Ä–≤", "+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö"))
        self._save_templates()
        
        await utils.answer(
            message,
            "‚úÖ <b>–®–∞–±–ª–æ–Ω '—Ä–≤' –¥–æ–±–∞–≤–ª–µ–Ω</b>\n"
            "–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤–≤–æ–¥–µ '—Ä–≤' –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—è—Ç—å—Å—è –Ω–∞:\n"
            "<code>+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö</code>"
        )
    
    @loader.command(
        ru_doc="–ü–æ–º–æ—â—å –ø–æ –º–æ–¥—É–ª—é",
        en_doc="Module help"
    )
    async def replacehelpcmd(self, message):
        """–ü–æ–º–æ—â—å"""
        await utils.answer(message, self.strings("help"))
    
    def _apply_replacements(self, text):
        """–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –∑–∞–º–µ–Ω—ã –∫ —Ç–µ–∫—Å—Ç—É"""
        result = text
        
        # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã –ø–æ –¥–ª–∏–Ω–µ (–æ—Ç —Å–∞–º—ã—Ö –¥–ª–∏–Ω–Ω—ã—Ö –∫ —Å–∞–º—ã–º –∫–æ—Ä–æ—Ç–∫–∏–º)
        # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∑–∞–º–µ–Ω
        sorted_templates = sorted(self.templates, key=lambda x: len(x[0]), reverse=True)
        
        for pattern, replacement in sorted_templates:
            # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤–∞
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ü–µ–ª—ã—Ö —Å–ª–æ–≤
            pattern_regex = r'\b' + re.escape(pattern) + r'\b'
            result = re.sub(pattern_regex, replacement, result, flags=re.IGNORECASE)
        
        return result
    
    def _save_templates(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        self.db.set(__name__, "templates", self.templates)
    
    async def on_unload(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self._save_templates()
