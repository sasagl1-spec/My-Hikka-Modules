# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/auto-replace.png
# meta description: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ —Ä–≤ –Ω–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
# scope: hikka_only
# scope: hikka_min 1.6.0

from .. import loader, utils
import logging
import re

logger = logging.getLogger(__name__)

@loader.tds
class AutoReplacerMod(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ —Ä–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    
    strings = {
        "name": "AutoReplacer",
        "help": "üîÑ <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞</b>\n\n"
                "üîß <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</b>\n"
                ".autoon - –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É\n"
                ".autooff - –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É\n"
                ".autostatus - –°—Ç–∞—Ç—É—Å\n"
                ".addauto <—Å–ª–æ–≤–æ> <–∑–∞–º–µ–Ω–∞> - –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ\n"
                ".listauto - –°–ø–∏—Å–æ–∫ –∑–∞–º–µ–Ω\n"
                ".delauto <–Ω–æ–º–µ—Ä> - –£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ–Ω—É\n"
                ".testauto <—Ç–µ–∫—Å—Ç> - –¢–µ—Å—Ç –∑–∞–º–µ–Ω—ã\n\n"
                "üìù <b>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:</b>\n"
                "'—Ä–≤' ‚Üí '+79902136543 –ü–°–ë –ë–∞–Ω–∫\\n–í–∞—Å–∏–ª–∏–π –ö'",
        "enabled": "‚úÖ <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞</b>",
        "disabled": "‚èπÔ∏è <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞</b>",
        "already_enabled": "‚ö†Ô∏è <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞</b>",
        "already_disabled": "‚ö†Ô∏è <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ —É–∂–µ –≤—ã–∫–ª—é—á–µ–Ω–∞</b>",
        "status_on": "üü¢ <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞: –í–ö–õ–Æ–ß–ï–ù–ê</b>",
        "status_off": "üî¥ <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞: –í–´–ö–õ–Æ–ß–ï–ù–ê</b>",
        "word_added": "‚úÖ <b>–î–æ–±–∞–≤–ª–µ–Ω–æ:</b> <code>{}</code> ‚Üí <code>{}</code>",
        "word_exists": "‚ö†Ô∏è <b>–°–ª–æ–≤–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</b>",
        "word_removed": "üóëÔ∏è <b>–£–¥–∞–ª–µ–Ω–æ:</b> <code>{}</code>",
        "no_words": "üì≠ <b>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω</b>",
        "words_list": "üìã <b>–°–ø–∏—Å–æ–∫ –∑–∞–º–µ–Ω:</b>\n{}",
        "invalid_number": "‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä</b>",
        "test_result": "üß™ <b>–¢–µ—Å—Ç –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã:</b>\n"
                       "<b>–ò—Å—Ö–æ–¥–Ω—ã–π:</b> {}\n"
                       "<b>–ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã:</b> {}",
        "replaced_info": "üîÑ <i>–°–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω–µ–Ω–æ</i>",
        "no_text": "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∞</b>"
    }
    
    def __init__(self):
        self.replacements = [
            ("—Ä–≤", "+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö"),
            ("—Ä—Ñ", "üá∑üá∫ –†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è"),
            ("—Å–ø—Å", "–°–ø–∞—Å–∏–±–æ!"),
            ("–ø–∂", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞")
        ]
        self.enabled = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        saved_replacements = self.db.get(__name__, "replacements", None)
        if saved_replacements:
            self.replacements = saved_replacements
        
        saved_enabled = self.db.get(__name__, "enabled", None)
        if saved_enabled is not None:
            self.enabled = saved_enabled
        
        logger.info(f"AutoReplacer –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–º–µ–Ω: {len(self.replacements)}, —Å—Ç–∞—Ç—É—Å: {'–í–ö–õ' if self.enabled else '–í–´–ö–õ'}")
    
    async def watcher(self, message):
        """–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞
        if not self.enabled:
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç
        if not message.out or not message.text:
            return
        
        # –ò—Å–∫–ª—é—á–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –º–æ–¥—É–ª—è –∏–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        if message.text.startswith(('.autoon', '.autooff', '.autostatus', 
                                   '.addauto', '.listauto', '.delauto', '.testauto',
                                   '.autohelp')):
            return
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–º–µ–Ω—ã
        original_text = message.text
        replaced_text = self._apply_auto_replace(original_text)
        
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if replaced_text != original_text:
            try:
                # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                await message.edit(replaced_text)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ —Å–µ–±–µ)
                await message.respond(self.strings("replaced_info"), reply_to=message.id)
                
                logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω–µ–Ω–æ: '{original_text}' ‚Üí '{replaced_text}'")
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    
    @loader.command(
        ru_doc="–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="Enable auto-replace"
    )
    async def autooncmd(self, message):
        """–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É"""
        if self.enabled:
            await utils.answer(message, self.strings("already_enabled"))
            return
        
        self.enabled = True
        self.db.set(__name__, "enabled", True)
        
        await utils.answer(message, self.strings("enabled"))
        logger.info("–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞")
    
    @loader.command(
        ru_doc="–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="Disable auto-replace"
    )
    async def autooffcmd(self, message):
        """–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É"""
        if not self.enabled:
            await utils.answer(message, self.strings("already_disabled"))
            return
        
        self.enabled = False
        self.db.set(__name__, "enabled", False)
        
        await utils.answer(message, self.strings("disabled"))
        logger.info("–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞")
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã",
        en_doc="Auto-replace status"
    )
    async def autostatuscmd(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status_text = self.strings["status_on"] if self.enabled else self.strings["status_off"]
        
        info = f"{status_text}\n\n"
        info += f"üìä <b>–í—Å–µ–≥–æ –∑–∞–º–µ–Ω:</b> {len(self.replacements)}\n"
        info += f"üîÑ <b>–ü—Ä–∏–º–µ—Ä:</b> '—Ä–≤' ‚Üí '{self.replacements[0][1][:30]}...'"
        
        await utils.answer(message, info)
    
    @loader.command(
        ru_doc="<—Å–ª–æ–≤–æ> <–∑–∞–º–µ–Ω–∞> - –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="<word> <replacement> - Add auto-replacement"
    )
    async def addautocmd(self, message):
        """–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É"""
        args = utils.get_args(message)
        
        if len(args) < 2:
            await utils.answer(
                message,
                "‚ùå <b>–§–æ—Ä–º–∞—Ç:</b> .addauto <—Å–ª–æ–≤–æ> <–∑–∞–º–µ–Ω–∞>\n"
                "–ü—Ä–∏–º–µ—Ä: .addauto –∞–¥—Ä–µ—Å –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, 1"
            )
            return
        
        word = args[0].lower()  # –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        replacement = " ".join(args[1:])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ —Å–ª–æ–≤–æ
        for existing_word, _ in self.replacements:
            if existing_word == word:
                await utils.answer(message, self.strings("word_exists"))
                return
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–º–µ–Ω—É –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
        self.replacements.insert(0, (word, replacement))
        self._save_replacements()
        
        await utils.answer(
            message,
            self.strings("word_added").format(word, replacement)
        )
        logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω–∞: '{word}' ‚Üí '{replacement}'")
    
    @loader.command(
        ru_doc="–°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω",
        en_doc="List auto-replacements"
    )
    async def listautocmd(self, message):
        """–°–ø–∏—Å–æ–∫ –∑–∞–º–µ–Ω"""
        if not self.replacements:
            await utils.answer(message, self.strings("no_words"))
            return
        
        list_text = ""
        for i, (word, replacement) in enumerate(self.replacements, 1):
            # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–∞–º–µ–Ω—ã
            repl_preview = replacement[:40] + "..." if len(replacement) > 40 else replacement
            list_text += f"{i}. <code>{word}</code> ‚Üí <code>{repl_preview}</code>\n"
        
        await utils.answer(
            message,
            self.strings("words_list").format(list_text)
        )
    
    @loader.command(
        ru_doc="<–Ω–æ–º–µ—Ä> - –£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="<number> - Remove auto-replacement"
    )
    async def delautocmd(self, message):
        """–£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É"""
        args = utils.get_args(message)
        
        if not args:
            await utils.answer(
                message,
                "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</b>\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .listauto —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–º–µ—Ä–∞"
            )
            return
        
        try:
            word_num = int(args[0]) - 1
            
            if 0 <= word_num < len(self.replacements):
                removed_word, removed_replacement = self.replacements.pop(word_num)
                self._save_replacements()
                
                await utils.answer(
                    message,
                    self.strings("word_removed"].format(removed_word)
                )
                logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω–∞: '{removed_word}'")
            else:
                await utils.answer(message, self.strings("invalid_number"))
                
        except ValueError:
            await utils.answer(message, self.strings("invalid_number"))
    
    @loader.command(
        ru_doc="<—Ç–µ–∫—Å—Ç> - –¢–µ—Å—Ç –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã",
        en_doc="<text> - Test auto-replacement"
    )
    async def testautocmd(self, message):
        """–¢–µ—Å—Ç –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã"""
        text = utils.get_args_raw(message)
        
        if not text:
            await utils.answer(message, self.strings("no_text"))
            return
        
        replaced_text = self._apply_auto_replace(text)
        
        await utils.answer(
            message,
            self.strings("test_result").format(text, replaced_text)
        )
    
    @loader.command(
        ru_doc="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–≤",
        en_doc="Quick add —Ä–≤"
    )
    async def addrvautocmd(self, message):
        """–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–≤"""
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
        self.replacements = [(w, r) for w, r in self.replacements if w != "—Ä–≤"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ä–≤ –≤ –Ω–∞—á–∞–ª–æ
        self.replacements.insert(0, ("—Ä–≤", "+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö"))
        self._save_replacements()
        
        await utils.answer(
            message,
            "‚úÖ <b>–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ '—Ä–≤'</b>\n"
            "–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤–≤–æ–¥–µ '—Ä–≤' –≤ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏:\n"
            "<code>+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö</code>"
        )
        logger.info("–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ '—Ä–≤'")
    
    @loader.command(
        ru_doc="–ü–æ–º–æ—â—å –ø–æ –º–æ–¥—É–ª—é",
        en_doc="Module help"
    )
    async def autohelpcmd(self, message):
        """–ü–æ–º–æ—â—å"""
        await utils.answer(message, self.strings("help"))
    
    def _apply_auto_replace(self, text):
        """–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã –∫ —Ç–µ–∫—Å—Ç—É"""
        result = text
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–º–µ–Ω—ã –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ø–∏—Å–∫–∞
        for word, replacement in self.replacements:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ü–µ–ª—ã—Ö —Å–ª–æ–≤
            # –£—á–∏—Ç—ã–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ–≤ –∏ —Ä–µ–≥–∏—Å—Ç—Ä
            pattern = r'\b' + re.escape(word) + r'\b'
            result = re.sub(pattern, replacement, result, flags=re.IGNORECASE)
        
        return result
    
    def _save_replacements(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        self.db.set(__name__, "replacements", self.replacements)
    
    async def on_unload(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self._save_replacements()
        self.db.set(__name__, "enabled", self.enabled)
