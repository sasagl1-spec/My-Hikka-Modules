# -*- coding: utf-8 -*-
# –ú–æ–¥—É–ª—å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –∫–æ–º–∞–Ω–¥ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

from .. import loader, utils
import asyncio
import random
import logging

logger = logging.getLogger(__name__)

@loader.tds
class CustomAutoPoster(loader.Module):
    """–ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏"""
    
    strings = {"name": "CustomPoster"}

    def __init__(self):
        self.is_active = False
        self.task = None
        
        # –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        self.target_chats = [
            "https://t.me/piteraq",
            "https://t.me/vpiskavipspb",
            "https://t.me/VpISkA991",
            "https://t.me/sextimeeeeeee",
            "https://t.me/vpiski_ekat",
            "https://t.me/tusovkimscspb",
            "https://t.me/vpiski_spb_piter_znakomstva",
            "https://t.me/vpiskimsksspb",
            "https://t.me/chat_berdjansk",
            "https://t.me/chatikiip",
            "https://t.me/vpisk_moskova",
            "https://t.me/moskva_vpiskip",
            "https://t.me/Moskvavispka",
            "https://t.me/vpiska_chelyaba001",
            "https://t.me/vpiskaa_spb",
            "https://t.me/vpiska_beseda",
            "https://t.me/MOSCOW_VPISKI_TOP",
            "https://t.me/wpiska_moscow",
            "https://t.me/vpiski_msk99",
            "https://t.me/msvpis",
            "https://t.me/vpiski_Moskow1",
            "https://t.me/VAO_v_piska",
            "https://t.me/vpiskimsk77"
        ]
        
        self.ad_message = "–≠—Å–∫–æ—Ä—Ç —É—Å–ª—É–≥–∏ —É –º–µ–Ω—è –≤ –ø—Ä–æ—Ñ–∏–ª–µü§§ \n–î–µ–≤—É—à–∫–∏ –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Åüíå"

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("CustomPoster –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")

    async def cap_startcmd(self, message):
        """–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞: .cap_start"""
        if self.is_active:
            await utils.answer(message, "‚ö†Ô∏è –ú–æ–¥—É–ª—å —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω")
            return
        
        self.is_active = True
        await utils.answer(message, "üöÄ –ó–∞–ø—É—Å–∫–∞—é —Ü–∏–∫–ª –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞...")
        
        self.task = asyncio.create_task(self.auto_posting_cycle())
        await utils.answer(message, "‚úÖ –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")

    async def cap_stopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞: .cap_stop"""
        if not self.is_active:
            await utils.answer(message, "‚ÑπÔ∏è –ú–æ–¥—É–ª—å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω")
            return
        
        self.is_active = False
        if self.task:
            self.task.cancel()
            try:
                await self.task
            except asyncio.CancelledError:
                pass
        
        await utils.answer(message, "‚èπÔ∏è –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

    async def cap_statscmd(self, message):
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: .cap_stats"""
        status = "üü¢ –ê–ö–¢–ò–í–ï–ù" if self.is_active else "üî¥ –û–°–¢–ê–ù–û–í–õ–ï–ù"
        stats_text = f"""
üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ú–û–î–£–õ–Ø:

‚Ä¢ –°—Ç–∞—Ç—É—Å: {status}
‚Ä¢ –í—Å–µ–≥–æ —á–∞—Ç–æ–≤: {len(self.target_chats)}
‚Ä¢ –ß–∞—Ç–æ–≤ –∑–∞ —Ü–∏–∫–ª: 3
‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª: 70 —Å–µ–∫—É–Ω–¥
‚Ä¢ –ü–∞—É–∑–∞ –º–µ–∂–¥—É: 5 —Å–µ–∫—É–Ω–¥
‚Ä¢ –†–µ–∂–∏–º: –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥
        """
        await utils.answer(message, stats_text)

    async def cap_testcmd(self, message):
        """–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç: .cap_test"""
        try:
            if len(self.target_chats) < 3:
                await utils.answer(message, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —á–∞—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞")
                return
            
            selected_chats = random.sample(self.target_chats, 3)
            results = []
            
            for i, chat in enumerate(selected_chats):
                try:
                    await self.client.send_message(chat, self.ad_message)
                    results.append(f"‚úÖ –ß–∞—Ç {i+1}: —É—Å–ø–µ—à–Ω–æ")
                    
                    if i < 2:
                        await asyncio.sleep(5)
                        
                except Exception as e:
                    error_msg = str(e)[:50]
                    results.append(f"‚ùå –ß–∞—Ç {i+1}: –æ—à–∏–±–∫–∞ ({error_msg})")
            
            response = "üß™ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ê:\n\n" + "\n".join(results)
            await utils.answer(message, response)
            
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: {str(e)[:100]}")

    async def cap_listcmd(self, message):
        """–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤: .cap_list"""
        if not self.target_chats:
            await utils.answer(message, "üì≠ –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø—É—Å—Ç")
            return
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 —á–∞—Ç–æ–≤
        chat_list = "\n".join([f"{i+1}. {chat}" for i, chat in enumerate(self.target_chats[:10])])
        
        if len(self.target_chats) > 10:
            chat_list += f"\n... –∏ –µ—â–µ {len(self.target_chats) - 10} —á–∞—Ç–æ–≤"
        
        await utils.answer(message, f"üìã –ß–ê–¢–´ –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò:\n{chat_list}")

    async def auto_posting_cycle(self):
        """–¶–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏"""
        logger.info("–ó–∞–ø—É—â–µ–Ω —Ü–∏–∫–ª –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞")
        
        cycle_number = 0
        
        while self.is_active:
            cycle_number += 1
            
            try:
                # –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 70 —Å–µ–∫—É–Ω–¥
                logger.debug(f"–¶–∏–∫–ª #{cycle_number}: –æ–∂–∏–¥–∞–Ω–∏–µ 70 —Å–µ–∫—É–Ω–¥")
                await asyncio.sleep(70)
                
                if not self.is_active:
                    break
                
                # –í—ã–±–∏—Ä–∞–µ–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∞—Ç–∞
                if len(self.target_chats) >= 3:
                    current_chats = random.sample(self.target_chats, 3)
                else:
                    current_chats = self.target_chats
                
                # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –ø–∞—É–∑–æ–π 5 —Å–µ–∫—É–Ω–¥
                for i, chat in enumerate(current_chats):
                    try:
                        await self.client.send_message(chat, self.ad_message)
                        logger.info(f"–¶–∏–∫–ª #{cycle_number}: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat}")
                        
                        if i < len(current_chats) - 1:
                            await asyncio.sleep(5)
                            
                    except Exception as e:
                        logger.error(f"–¶–∏–∫–ª #{cycle_number}, –æ—à–∏–±–∫–∞ –≤ {chat}: {e}")
                        continue
                
                logger.info(f"–¶–∏–∫–ª #{cycle_number} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω")
                
            except asyncio.CancelledError:
                logger.info("–¶–∏–∫–ª –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
                break
                
            except Exception as e:
                logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ #{cycle_number}: {e}")
                
                if self.is_active:
                    await asyncio.sleep(30)  # –ü–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

    async def cap_helpcmd(self, message):
        """–°–ø—Ä–∞–≤–∫–∞: .cap_help"""
        help_text = """
ü§ñ –ú–û–î–£–õ–¨ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –†–ê–°–°–´–õ–ö–ò

üìã –ö–û–ú–ê–ù–î–´ (–≤—Å–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å cap_):
‚Ä¢ .cap_start - –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥
‚Ä¢ .cap_stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥
‚Ä¢ .cap_stats - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
‚Ä¢ .cap_test - –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
‚Ä¢ .cap_list - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
‚Ä¢ .cap_help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

‚öôÔ∏è –ü–ê–†–ê–ú–ï–¢–†–´ –†–ê–ë–û–¢–´:
‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏: 70 —Å–µ–∫—É–Ω–¥
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ü–∏–∫–ª: 3 —á–∞—Ç–∞
‚Ä¢ –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏: 5 —Å–µ–∫—É–Ω–¥
‚Ä¢ –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä —á–∞—Ç–æ–≤: –î–ê
‚Ä¢ –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª: –î–ê

‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø:
1. –ú–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ –∫–æ–º–∞–Ω–¥—ã .cap_stop
2. –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏
3. –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ .cap_stop
4. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ
        """
        await utils.answer(message, help_text)

    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self.is_active = False
        if self.task:
            self.task.cancel()
        logger.info("–ú–æ–¥—É–ª—å CustomPoster –≤—ã–≥—Ä—É–∂–µ–Ω")
