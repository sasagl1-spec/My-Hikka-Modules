# meta developer: @—Ç–≤–æ–π_–Ω–∏–∫
# meta pic: https://img.icons8.com/color/48/000000/flash-on.png
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class InstantCommentMod(loader.Module):
    """–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –Ω–æ–≤—ã–º –ø–æ—Å—Ç–æ–º (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏)"""
    
    strings = {
        "name": "InstantComment",
        "started": "‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!\nüì¢ –ö–∞–Ω–∞–ª: {}\nüí¨ –¢–µ–∫—Å—Ç: –ø–æ–¥–∞—Ä–∏ –º–Ω–µ –º–∏—à–∫—É üêª",
        "stopped": "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ",
        "already": "‚ö†Ô∏è –£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç",
        "not_running": "üì≠ –ù–µ –∑–∞–ø—É—â–µ–Ω–æ",
        "status_on": "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)",
        "status_off": "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ",
        "status_text": "üìä –°—Ç–∞—Ç—É—Å: {}\nüì¢ –ö–∞–Ω–∞–ª: {}\nüí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ø–æ—Å—Ç {}\n‚ö° –ó–∞–¥–µ—Ä–∂–∫–∞: 0 –º—Å"
    }
    
    def __init__(self):
        self.is_running = False
        self.target_channel_id = -1003084855353
        self.comment_text = "–ø–æ–¥–∞—Ä–∏ –º–Ω–µ –º–∏—à–∫—É üêª"
        self.last_commented_id = 0
    
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self.last_commented_id = self.db.get(__name__, "last_id", 0)
        logger.info(f"InstantComment –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {self.last_commented_id}")
    
    @loader.command(
        ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
        en_doc="Start instant commenting"
    )
    async def icstartcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å"""
        if self.is_running:
            await utils.answer(message, self.strings("already"))
            return
        
        self.is_running = True
        await utils.answer(
            message,
            self.strings("started").format(self.target_channel_id)
        )
        logger.info(f"–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ")
    
    @loader.command(
        ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
        en_doc="Stop"
    )
    async def icstopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"""
        if not self.is_running:
            await utils.answer(message, self.strings("not_running"))
            return
        
        self.is_running = False
        await utils.answer(message, self.strings("stopped"))
        logger.info("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å",
        en_doc="Status"
    )
    async def icstatuscmd(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status = self.strings["status_on"] if self.is_running else self.strings["status_off"]
        
        last = self.last_commented_id if self.last_commented_id > 0 else "–Ω–µ—Ç"
        
        await utils.answer(
            message,
            self.strings("status_text").format(
                status,
                self.target_channel_id,
                last
            )
        )
    
    @loader.command(
        ru_doc="–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è",
        en_doc="Change comment text"
    )
    async def ictextcmd(self, message):
        """–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è <–Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç>"""
        text = utils.get_args_raw(message)
        
        if not text:
            await utils.answer(
                message, 
                f"üìù –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç: {self.comment_text}\n\n"
                f"–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å: .ictext <–Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç>"
            )
            return
        
        self.comment_text = text
        await utils.answer(message, f"‚úÖ –¢–µ–∫—Å—Ç –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {self.comment_text}")
    
    @loader.command(
        ru_doc="–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫",
        en_doc="Reset counter"
    )
    async def icresetcmd(self, message):
        """–°–±—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π ID"""
        self.last_commented_id = 0
        self.db.set(__name__, "last_id", 0)
        await utils.answer(message, "üîÑ –°—á–µ—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω")
    
    async def watcher(self, message):
        """
        –ú–ì–ù–û–í–ï–ù–ù–û –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø–æ—Å—Ç
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ
        if not self.is_running:
            return
        
        try:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –∫–∞–Ω–∞–ª–∞
            chat_id = None
            if hasattr(message, 'peer_id'):
                if hasattr(message.peer_id, 'channel_id'):
                    chat_id = message.peer_id.channel_id
            elif hasattr(message, 'chat_id'):
                chat_id = message.chat_id
            
            # –ù–µ –Ω–∞—à –∫–∞–Ω–∞–ª
            if chat_id != self.target_channel_id:
                return
            
            # –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if message.out:
                return
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –ø–æ—Å—Ç (–Ω–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
            if hasattr(message, 'reply_to') and message.reply_to:
                if message.reply_to.reply_to_msg_id:
                    return
            
            # –£–∂–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø–æ—Å—Ç
            if message.id <= self.last_commented_id:
                return
            
            # ‚úÖ –ú–ì–ù–û–í–ï–ù–ù–´–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô (–±–µ–∑ await asyncio.sleep)
            logger.info(f"–ù–û–í–´–ô –ü–û–°–¢ {message.id} - –ö–û–ú–ú–ï–ù–¢–ò–†–£–Æ –ú–ì–ù–û–í–ï–ù–ù–û!")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ä–∞–∑—É
            await message.reply(self.comment_text)
            
            # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º
            self.last_commented_id = message.id
            self.db.set(__name__, "last_id", message.id)
            
            logger.info(f"‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ –ø–æ—Å—Ç {message.id}")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞: {e}")
    
    async def on_unload(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self.db.set(__name__, "last_id", self.last_commented_id)
