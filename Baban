# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/calculator--v1.png
# meta description: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
# scope: hikka_only
# scope: hikka_min 1.6.0

import math
import re
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class CalculatorMod(loader.Module):
    """–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π"""
    
    strings = {
        "name": "Calculator",
        "help": "üìü <b>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</b>\n\n"
                "üìù <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</b>\n"
                "<code>.calc 8+8</code> - —Å–ª–æ–∂–µ–Ω–∏–µ\n"
                "<code>.calc 10-5</code> - –≤—ã—á–∏—Ç–∞–Ω–∏–µ\n"
                "<code>.calc 6*7</code> - —É–º–Ω–æ–∂–µ–Ω–∏–µ\n"
                "<code>.calc 20/4</code> - –¥–µ–ª–µ–Ω–∏–µ\n"
                "<code>.calc 2^3</code> - –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å\n"
                "<code>.calc sqrt(16)</code> - –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å\n"
                "<code>.calc sin(30)</code> - —Å–∏–Ω—É—Å\n"
                "<code>.calc 2*pi</code> - —á–∏—Å–ª–æ œÄ\n\n"
                "üìä <b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
                ".calc (5+3)*2\n"
                ".calc 2^10\n"
                ".calc sqrt(25)+5",
        "no_expression": "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</b>",
        "result": "üìü <b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>\n<code>{expression} = {result}</code>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:</b> {}",
        "history": "üìú <b>–ò—Å—Ç–æ—Ä–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π:</b>\n{}",
        "no_history": "üì≠ <b>–ò—Å—Ç–æ—Ä–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞</b>",
        "history_cleared": "üóëÔ∏è <b>–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞</b>"
    }
    
    strings_ru = {
        "help": "üìü <b>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</b>\n\n"
                "üìù <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</b>\n"
                "<code>.calc 8+8</code> - —Å–ª–æ–∂–µ–Ω–∏–µ\n"
                "<code>.calc 10-5</code> - –≤—ã—á–∏—Ç–∞–Ω–∏–µ\n"
                "<code>.calc 6*7</code> - —É–º–Ω–æ–∂–µ–Ω–∏–µ\n"
                "<code>.calc 20/4</code> - –¥–µ–ª–µ–Ω–∏–µ\n"
                "<code>.calc 2^3</code> - –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å\n"
                "<code>.calc sqrt(16)</code> - –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å\n"
                "<code>.calc sin(30)</code> - —Å–∏–Ω—É—Å\n"
                "<code>.calc 2*pi</code> - —á–∏—Å–ª–æ œÄ\n\n"
                "üìä <b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
                ".calc (5+3)*2\n"
                ".calc 2^10\n"
                ".calc sqrt(25)+5",
        "no_expression": "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</b>",
        "result": "üìü <b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>\n<code>{expression} = {result}</code>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:</b> {}",
        "history": "üìú <b>–ò—Å—Ç–æ—Ä–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π:</b>\n{}",
        "no_history": "üì≠ <b>–ò—Å—Ç–æ—Ä–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞</b>",
        "history_cleared": "üóëÔ∏è <b>–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞</b>"
    }
    
    def __init__(self):
        self.history = []
        self.max_history = 10
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        self.history = self.db.get(__name__, "history", [])
        logger.info("Calculator –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(
        ru_doc="<–≤—ã—Ä–∞–∂–µ–Ω–∏–µ> - –í—ã—á–∏—Å–ª–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ",
        en_doc="<expression> - Calculate mathematical expression"
    )
    async def calccmd(self, message):
        """–í—ã—á–∏—Å–ª–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ"""
        expression = utils.get_args_raw(message)
        
        if not expression:
            await utils.answer(message, self.strings("no_expression"))
            return
        
        try:
            # –û—á–∏—â–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
            expression_clean = expression.strip()
            
            # –ó–∞–º–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª—ã –¥–ª—è Python
            expr_for_eval = self._prepare_expression(expression_clean)
            
            # –í—ã—á–∏—Å–ª—è–µ–º
            result = eval(expr_for_eval, {"__builtins__": {}}, 
                         {**math.__dict__, "pi": math.pi, "e": math.e})
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result_str = self._format_result(result)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self._add_to_history(expression_clean, result_str)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await utils.answer(
                message,
                self.strings("result").format(
                    expression=expression_clean,
                    result=result_str
                )
            )
            
            logger.info(f"–í—ã—á–∏—Å–ª–µ–Ω–æ: {expression_clean} = {result_str}")
            
        except ZeroDivisionError:
            await utils.answer(message, "‚ùå <b>–û—à–∏–±–∫–∞: –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å</b>")
        except Exception as e:
            await utils.answer(
                message,
                self.strings("error").format(str(e))
            )
            logger.error(f"–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: {e}")
    
    @loader.command(
        ru_doc="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É",
        en_doc="Show calculator help"
    )
    async def calchelpcmd(self, message):
        """–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É"""
        await utils.answer(message, self.strings("help"))
    
    @loader.command(
        ru_doc="–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—ã—á–∏—Å–ª–µ–Ω–∏–π",
        en_doc="Show calculation history"
    )
    async def calchistorycmd(self, message):
        """–ò—Å—Ç–æ—Ä–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π"""
        if not self.history:
            await utils.answer(message, self.strings("no_history"))
            return
        
        history_text = ""
        for i, (expr, result) in enumerate(reversed(self.history[-10:]), 1):
            history_text += f"{i}. <code>{expr} = {result}</code>\n"
        
        await utils.answer(
            message,
            self.strings("history").format(history_text)
        )
    
    @loader.command(
        ru_doc="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—ã—á–∏—Å–ª–µ–Ω–∏–π",
        en_doc="Clear calculation history"
    )
    async def calcclearhistorycmd(self, message):
        """–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"""
        self.history = []
        self.db.set(__name__, "history", self.history)
        await utils.answer(message, self.strings("history_cleared"))
    
    @loader.command(
        ru_doc="<–≤—ã—Ä–∞–∂–µ–Ω–∏–µ> - –ë—ã—Å—Ç—Ä—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é)",
        en_doc="<expression> - Quick calculator (no history)"
    )
    async def qcalccmd(self, message):
        """–ë—ã—Å—Ç—Ä—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"""
        expression = utils.get_args_raw(message)
        
        if not expression:
            await utils.answer(message, self.strings("no_expression"))
            return
        
        try:
            expr_for_eval = self._prepare_expression(expression)
            result = eval(expr_for_eval, {"__builtins__": {}}, 
                         {**math.__dict__, "pi": math.pi, "e": math.e})
            
            result_str = self._format_result(result)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            await utils.answer(
                message,
                f"‚ö° <b>–ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç:</b>\n"
                f"<code>{expression} = {result_str}</code>"
            )
            
        except ZeroDivisionError:
            await utils.answer(message, "‚ùå <b>–î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å</b>")
        except Exception as e:
            await utils.answer(message, f"‚ùå <b>–û—à–∏–±–∫–∞:</b> {str(e)}")
    
    @loader.command(
        ru_doc="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å —Ä–µ–ø–ª–∞–µ–º (–≤—ã—á–∏—Å–ª—è–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç–µ)",
        en_doc="Reply calculator (calculates expression in reply)"
    )
    async def rcalccmd(self, message):
        """–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å —Ä–µ–ø–ª–∞–µ–º"""
        reply = await message.get_reply_message()
        
        if not reply or not reply.text:
            await utils.answer(message, "‚ùå <b>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º</b>")
            return
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞
        expression = reply.text.strip()
        
        try:
            expr_for_eval = self._prepare_expression(expression)
            result = eval(expr_for_eval, {"__builtins__": {}}, 
                         {**math.__dict__, "pi": math.pi, "e": math.e})
            
            result_str = self._format_result(result)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self._add_to_history(expression, result_str)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await utils.answer(
                message,
                self.strings("result").format(
                    expression=expression,
                    result=result_str
                )
            )
            
        except Exception as e:
            await utils.answer(
                message,
                self.strings("error").format(str(e))
            )
    
    def _prepare_expression(self, expression):
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è"""
        # –ó–∞–º–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª—ã
        expr = expression
        
        # –ó–∞–º–µ–Ω—è–µ–º ^ –Ω–∞ ** (—Å—Ç–µ–ø–µ–Ω—å)
        expr = expr.replace('^', '**')
        
        # –ó–∞–º–µ–Ω—è–µ–º √∑ –Ω–∞ /
        expr = expr.replace('√∑', '/')
        
        # –ó–∞–º–µ–Ω—è–µ–º √ó –Ω–∞ *
        expr = expr.replace('√ó', '*')
        
        # –ó–∞–º–µ–Ω—è–µ–º ‚àö –Ω–∞ sqrt
        expr = expr.replace('‚àö', 'sqrt')
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É–º–Ω–æ–∂–µ–Ω–∏–µ —Ç–∞–º, –≥–¥–µ –æ–Ω–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç—Å—è (2œÄ ‚Üí 2*œÄ)
        expr = re.sub(r'(\d)([a-zA-Z(])', r'\1*\2', expr)
        expr = re.sub(r'([a-zA-Z)])(\d)', r'\1*\2', expr)
        
        # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
        if '%' in expr:
            expr = expr.replace('%', '/100')
        
        return expr
    
    def _format_result(self, result):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"""
        if isinstance(result, (int, float)):
            # –ï—Å–ª–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
            if result == int(result):
                return str(int(result))
            # –ï—Å–ª–∏ –¥—Ä–æ–±–Ω–æ–µ
            else:
                # –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 10 –∑–Ω–∞–∫–æ–≤ –∏ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –Ω—É–ª–∏
                formatted = f"{result:.10f}"
                formatted = formatted.rstrip('0').rstrip('.')
                return formatted
        return str(result)
    
    def _add_to_history(self, expression, result):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        self.history.append((expression, result))
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
        if len(self.history) > self.max_history:
            self.history = self.history[-self.max_history:]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        self.db.set(__name__, "history", self.history)
    
    async def on_unload(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self.db.set(__name__, "history", self.history)
