# meta developer: @yournick
from .. import loader, utils
import asyncio

@loader.tds
class TonSpamMod(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –∫–∞–∂–¥—ã—Ö 56 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ"""
    strings = {"name": "TonSpammer"}

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self.running = False
        self.last_msg_count = 0

    async def spamstartcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–∞—Ç–∞ @TonTakeGarant"""
        if self.running:
            await utils.answer(message, "<b>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–∂–µ –∑–∞–ø—É—â–µ–Ω!</b>")
            return
        
        self.running = True
        self.task = asyncio.create_task(self.monitor_chat())
        await utils.answer(message, "<b>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–∞—Ç–∞ –∑–∞–ø—É—â–µ–Ω!</b>")

    async def spamstopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"""
        if not self.running:
            await utils.answer(message, "<b>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –∑–∞–ø—É—â–µ–Ω!</b>")
            return
        
        self.running = False
        if self.task:
            self.task.cancel()
        await utils.answer(message, "<b>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!</b>")

    async def monitor_chat(self):
        target = "@TonTakeGarant"
        msg = """–ü—Ä–æ–¥–∞–º –ø–∞–ø–∫–∏ —Å 500+ —á–∞—Ç–∞–º–∏ –ø–æ —Ç–µ–º–∞—Ç–∏–∫–µ –Ω—Ñ—Ç 
1$/0.7 —Ç–æ–Ω 

–ù–∞–∫—Ä—É—Ç–∫–∞ –ª—é–±–æ–≥–æ –≤–∏–¥–∞üí¨ 
üë•–ü–æ–¥–ø–∏—Å—á–∏–∫–∏
üëç–†–µ–∞–∫—Ü–∏–∏
üëÄ–ü—Ä–æ—Å–º–æ—Ç—Ä—ã
‚úÖ–ø—Ä–∏–Ω–∏–º–∞—é —Ä—É–±–ª–∏, –±–∞–∫—Å—ã, —Ç–æ–Ω—ã, –∑–≤–µ–∑–¥—ã

–ü–∏—Å–∞—Ç—å —Å—é–¥–∞ @vingln"""
        
        chat = await self.client.get_entity(target)
        
        while self.running:
            try:
                messages = await self.client.get_messages(chat, limit=1)
                if messages:
                    current_count = messages[0].id
                    
                    if current_count % 56 == 0 and current_count != self.last_msg_count:
                        await self.client.send_message(chat, msg)
                        self.last_msg_count = current_count
                        
                await asyncio.sleep(5)
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞: {e}")
                await asyncio.sleep(10)
