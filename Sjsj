# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/telegram-app.png
# meta description: –ü–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω –∏–∑ @DurovKursBot –ø–æ —Ç–æ—á–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
import time
import re
from datetime import datetime, timedelta
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class DurovPriceBot(loader.Module):
    """–ü–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω –∏–∑ @DurovKursBot —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π 1 USDT –∏ 1 TON"""
    
    strings = {
        "name": "DurovPriceBot",
        "started": "‚úÖ <b>–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!</b>\nü§ñ –ò—Å—Ç–æ—á–Ω–∏–∫: @DurovKursBot\nüì¢ –ö–∞–Ω–∞–ª: @priceDollarTon\n‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª: 3 –º–∏–Ω—É—Ç—ã\nüìä –ö–æ–º–∞–Ω–¥—ã: 1 usd, 1 ton",
        "stopped": "‚èπÔ∏è <b>–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>",
        "already_running": "‚ö†Ô∏è <b>–ë–æ—Ç —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>",
        "not_running": "üì≠ <b>–ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω</b>",
        "test_sent": "üì§ <b>–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</b>",
        "status": "üîÑ <b>–°—Ç–∞—Ç—É—Å:</b> {}\n‚è∞ <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ:</b> {}\nüíµ <b>USD:</b> {}‚ÇΩ\nüíé <b>TON:</b> {}‚ÇΩ",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞:</b> {}",
        "sending_commands": "üì® –û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç—É...",
        "parsing_response": "üîç –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞...",
        "parsed_success": "‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã",
        "no_data": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
        "bot_error": "‚ùå @DurovKursBot –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª"
    }
    
    def __init__(self):
        self.task = None
        self.is_running = False
        self.last_update = None
        self.last_usd_price = None  # USD/RUB —Ü–µ–Ω–∞
        self.last_ton_price = None  # TON/RUB —Ü–µ–Ω–∞
        self.source_bot = "@DurovKursBot"
        self.target_channel = "@priceDollarTon"
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("DurovPriceBot –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(
        ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥",
        en_doc="Start automatic parsing"
    )
    async def startdurovbot(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"""
        if self.is_running:
            await utils.answer(message, self.strings("already_running"))
            return
        
        self.is_running = True
        self.task = asyncio.create_task(self._main_loop())
        
        await utils.answer(message, self.strings("started"))
        logger.info("DurovPriceBot –∑–∞–ø—É—â–µ–Ω")
    
    @loader.command(
        ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞",
        en_doc="Stop bot"
    )
    async def stopdurovbot(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞"""
        if not self.is_running:
            await utils.answer(message, self.strings("not_running"))
            return
        
        self.is_running = False
        if self.task:
            self.task.cancel()
            self.task = None
        
        await utils.answer(message, self.strings("stopped"))
        logger.info("DurovPriceBot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    @loader.command(
        ru_doc="–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç (–∑–∞–ø—Ä–æ—Å + –ø–∞—Ä—Å–∏–Ω–≥ + –ø–æ—Å—Ç)",
        en_doc="Full test (request + parsing + post)"
    )
    async def testdurovfull(self, message):
        """–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å"""
        await utils.answer(message, self.strings("sending_commands"))
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã
            usd_price, ton_price = await self._fetch_prices()
            
            if usd_price and ton_price:
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç
                post = self._format_post(usd_price, ton_price)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
                await self.client.send_message(
                    self.target_channel,
                    post,
                    parse_mode='HTML'
                )
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                self.last_usd_price = usd_price
                self.last_ton_price = ton_price
                self.last_update = time.time()
                
                await utils.answer(message, self.strings("test_sent"))
                await message.respond(post, parse_mode='HTML')
            else:
                await utils.answer(message, self.strings("bot_error"))
                
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥)",
        en_doc="Quick test (parsing only)"
    )
    async def testdurovparse(self, message):
        """–¢–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥"""
        await utils.answer(message, self.strings("parsing_response"))
        
        try:
            usd_price, ton_price = await self._fetch_prices()
            
            if usd_price and ton_price:
                result = f"‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω!\n\n"
                result += f"üíµ USD/RUB: {usd_price:.2f}‚ÇΩ\n"
                result += f"üíé TON/RUB: {ton_price:.2f}‚ÇΩ\n\n"
                result += f"–ü—Ä–∏–º–µ—Ä –ø–æ—Å—Ç–∞:\n{self._format_post(usd_price, ton_price)}"
                
                await utils.answer(message, result)
            else:
                await utils.answer(message, self.strings("bot_error"))
                
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞",
        en_doc="Bot status"
    )
    async def durovbotstatus(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç" if self.is_running else "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        last_time = "‚Äî"
        if self.last_update:
            last_time = self._get_msk_time_str(self.last_update)
        
        usd_info = f"{self.last_usd_price:.2f}‚ÇΩ" if self.last_usd_price else self.strings("no_data")
        ton_info = f"{self.last_ton_price:.2f}‚ÇΩ" if self.last_ton_price else self.strings("no_data")
        
        info = self.strings("status").format(status, last_time, usd_info, ton_info)
        await utils.answer(message, info)
    
    @loader.command(
        ru_doc="–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å –∏ –ø–æ–∫–∞–∑–∞—Ç—å",
        en_doc="Update now and show"
    )
    async def updatedurovnow(self, message):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å"""
        await utils.answer(message, self.strings("sending_commands"))
        
        try:
            usd_price, ton_price = await self._fetch_prices()
            
            if usd_price and ton_price:
                post = self._format_post(usd_price, ton_price)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                self.last_usd_price = usd_price
                self.last_ton_price = ton_price
                self.last_update = time.time()
                
                await message.respond(post, parse_mode='HTML')
            else:
                await utils.answer(message, self.strings("bot_error"))
                
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É",
        en_doc="Send command to bot"
    )
    async def senddurovcmd(self, message):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É <—Ç–µ–∫—Å—Ç>"""
        args = utils.get_args_raw(message)
        
        if not args:
            await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É\n–ü—Ä–∏–º–µ—Ä: .senddurovcmd 1 usd")
            return
        
        try:
            await self.client.send_message(self.source_bot, args)
            await utils.answer(message, f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: `{args}`")
            
            # –ñ–¥–µ–º –æ—Ç–≤–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            await asyncio.sleep(2)
            messages = await self.client.get_messages(self.source_bot, limit=3)
            
            for msg in messages:
                if msg.text and msg.out is False:
                    await message.respond(f"üì® –û—Ç–≤–µ—Ç –±–æ—Ç–∞:\n```\n{msg.text[:400]}\n```")
                    break
                    
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
    
    async def _main_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã"""
        logger.info("–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∑–∞–ø—É—â–µ–Ω")
        
        while self.is_running:
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã
                usd_price, ton_price = await self._fetch_prices()
                
                if usd_price and ton_price:
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    self.last_usd_price = usd_price
                    self.last_ton_price = ton_price
                    self.last_update = time.time()
                    
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç
                    post = self._format_post(usd_price, ton_price)
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
                    await self.client.send_message(
                        self.target_channel,
                        post,
                        parse_mode='HTML'
                    )
                    
                    logger.info(f"–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω | USD: {usd_price:.2f}‚ÇΩ, TON: {ton_price:.2f}‚ÇΩ")
                
                # –ñ–¥–µ–º 3 –º–∏–Ω—É—Ç—ã –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
                wait_time = 180  # 3 –º–∏–Ω—É—Ç—ã
                for i in range(wait_time):
                    if not self.is_running:
                        break
                    await asyncio.sleep(1)
                    
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
                await asyncio.sleep(30)  # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
    
    async def _fetch_prices(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω –æ—Ç –±–æ—Ç–∞"""
        try:
            # –®–∞–≥ 1: –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º /start)
            await self.client.send_message(self.source_bot, "/start")
            await asyncio.sleep(1)
            
            # –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "1 usd" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ USD
            await self.client.send_message(self.source_bot, "1 usd")
            await asyncio.sleep(2)
            
            # –®–∞–≥ 3: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "1 ton" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ TON
            await self.client.send_message(self.source_bot, "1 ton")
            await asyncio.sleep(2)
            
            # –®–∞–≥ 4: –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            messages = await self.client.get_messages(self.source_bot, limit=10)
            
            usd_price = None
            ton_price = None
            
            # –ò—â–µ–º –æ—Ç–≤–µ—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            for msg in messages:
                if msg.text and msg.out is False:  # –¢–æ–ª—å–∫–æ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    text = msg.text
                    
                    # –ò—â–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é USDT (USD)
                    if "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 1.0 USDT" in text and not usd_price:
                        usd_price = self._extract_price_from_conversion(text, "USDT")
                    
                    # –ò—â–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é TON
                    if "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 1.0 TON" in text and not ton_price:
                        ton_price = self._extract_price_from_conversion(text, "TON")
                    
                    # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –æ–±–µ —Ü–µ–Ω—ã, –≤—ã—Ö–æ–¥–∏–º
                    if usd_price and ton_price:
                        break
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
            if not usd_price or not ton_price:
                # –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
                await self.client.send_message(self.source_bot, "1 USDT")
                await asyncio.sleep(2)
                
                await self.client.send_message(self.source_bot, "1 TON")
                await asyncio.sleep(2)
                
                messages = await self.client.get_messages(self.source_bot, limit=10)
                
                for msg in messages:
                    if msg.text and msg.out is False:
                        text = msg.text
                        
                        if not usd_price:
                            usd_price = self._extract_price_from_conversion(text, "USDT")
                        
                        if not ton_price:
                            ton_price = self._extract_price_from_conversion(text, "TON")
            
            return usd_price, ton_price
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω: {e}")
            return None, None
    
    def _extract_price_from_conversion(self, text, currency_type):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
        try:
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å RUB –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
            # "RUB : 76.09" –∏–ª–∏ "RUB: 119.39"
            pattern = r'RUB\s*:\s*([\d]+[.,]\d+)'
            match = re.search(pattern, text)
            
            if match:
                price_str = match.group(1).replace(',', '.')
                price = float(price_str)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—É–º–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
                if currency_type == "USDT":
                    if 30 <= price <= 150:  # USD –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 30-150 —Ä—É–±
                        return round(price, 2)
                elif currency_type == "TON":
                    if 10 <= price <= 1000:  # TON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 10-1000 —Ä—É–±
                        return round(price, 2)
            
            return None
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–µ–Ω—ã {currency_type}: {e}")
            return None
    
    def _get_msk_time(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –ú–°–ö"""
        utc_now = datetime.utcnow()
        msk_time = utc_now + timedelta(hours=3)
        return msk_time
    
    def _get_msk_time_str(self, timestamp=None):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ú–°–ö"""
        if timestamp:
            utc_time = datetime.utcfromtimestamp(timestamp)
            msk_time = utc_time + timedelta(hours=3)
        else:
            msk_time = self._get_msk_time()
        
        return msk_time.strftime("%H:%M –ú–°–ö")
    
    def _format_number(self, number):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å —Ä—É—Å—Å–∫–∏–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º"""
        if isinstance(number, (int, float)):
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å 2 –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            formatted = f"{number:,.2f}"
            
            # –ó–∞–º–µ–Ω—è–µ–º —Ç–æ—á–∫—É –Ω–∞ –∑–∞–ø—è—Ç—É—é –¥–ª—è –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö
            formatted = formatted.replace(".", ",")
            
            # –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π —Ç—ã—Å—è—á
            formatted = formatted.replace(",", " ", 1) if "," in formatted else formatted
            
            # –£–±–∏—Ä–∞–µ–º .00 –µ—Å–ª–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
            if formatted.endswith(",00"):
                formatted = formatted[:-3]
            
            return formatted
        return str(number)
    
    def _format_post(self, usd_price, ton_price):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –≤ —Ç–æ—á–Ω–æ–º —Ç—Ä–µ–±—É–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ"""
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞
        usd_formatted = self._format_number(usd_price)
        ton_formatted = self._format_number(ton_price)
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ú–°–ö
        msk_time = self._get_msk_time_str()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ—Å—Ç –¢–û–ß–ù–û –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        post = f"üíµ USD: <b>{usd_formatted}‚ÇΩ</b>\n"
        post += f"üíé TON: <b>{ton_formatted}‚ÇΩ</b>\n\n"
        post += f"<i>üïê {msk_time} | @priceDollarTon</i>"
        
        return post
    
    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self.is_running = False
        
        if self.task:
            self.task.cancel()
