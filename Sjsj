# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/durov.png
# meta description: –†–∞–±–æ—á–∏–π –ø–∞—Ä—Å–µ—Ä @DurovKursBot —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –æ—Ç–≤–µ—Ç–æ–≤
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
import time
import re
from datetime import datetime, timedelta
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class DurovParserWorking(loader.Module):
    """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä @DurovKursBot —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –æ—Ç–≤–µ—Ç–æ–≤"""
    
    strings = {
        "name": "DurovParserWorking",
        "started": "‚úÖ <b>–ü–∞—Ä—Å–µ—Ä –∑–∞–ø—É—â–µ–Ω!</b>\nü§ñ –ë–æ—Ç: @DurovKursBot\nüì¢ –ö–∞–Ω–∞–ª: @priceDollarTon\n‚è± –ö–∞–∂–¥—ã–µ 3 –º–∏–Ω",
        "stopped": "‚èπÔ∏è <b>–ü–∞—Ä—Å–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>",
        "already_running": "‚ö†Ô∏è <b>–£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>",
        "not_running": "üì≠ <b>–ù–µ –∑–∞–ø—É—â–µ–Ω</b>",
        "test_sent": "üì§ <b>–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</b>",
        "status": "üîÑ <b>–°—Ç–∞—Ç—É—Å:</b> {}\n‚è∞ <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ:</b> {}\nüíµ <b>USD:</b> {}‚ÇΩ\nüíé <b>TON:</b> {}‚ÇΩ",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞:</b> {}",
        "debug_mode": "üîß <b>–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤–∫–ª—é—á–µ–Ω</b>",
        "debug_off": "üîß <b>–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω</b>",
        "checking_bot": "üîç –ü—Ä–æ–≤–µ—Ä—è—é —Å–≤—è–∑—å —Å –±–æ—Ç–æ–º...",
        "bot_responding": "‚úÖ –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ",
        "parsing_debug": "üìä –û—Ç–ª–∞–¥–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞..."
    }
    
    def __init__(self):
        self.task = None
        self.is_running = False
        self.last_update = None
        self.last_usd_price = None
        self.last_ton_price = None
        self.source_bot = "@DurovKursBot"
        self.target_channel = "@priceDollarTon"
        self.debug_mode = False  # –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("DurovParserWorking –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(
        ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥",
        en_doc="Start parsing"
    )
    async def startdurovwork(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å"""
        if self.is_running:
            await utils.answer(message, self.strings("already_running"))
            return
        
        self.is_running = True
        self.task = asyncio.create_task(self._working_loop())
        
        await utils.answer(message, self.strings("started"))
        logger.info("–†–∞–±–æ—á–∏–π –ø–∞—Ä—Å–µ—Ä –∑–∞–ø—É—â–µ–Ω")
    
    @loader.command(
        ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥",
        en_doc="Stop parsing"
    )
    async def stopdurovwork(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"""
        if not self.is_running:
            await utils.answer(message, self.strings("not_running"))
            return
        
        self.is_running = False
        if self.task:
            self.task.cancel()
            self.task = None
        
        await utils.answer(message, self.strings("stopped"))
        logger.info("–ü–∞—Ä—Å–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    @loader.command(
        ru_doc="–¢–µ—Å—Ç —Å–≤—è–∑–∏ —Å –±–æ—Ç–æ–º",
        en_doc="Test bot connection"
    )
    async def testbotconnection(self, message):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å"""
        await utils.answer(message, self.strings("checking_bot"))
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É
            await self.client.send_message(self.source_bot, "1 usd")
            await asyncio.sleep(2)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            messages = await self.client.get_messages(self.source_bot, limit=10)
            
            response_count = 0
            debug_info = "üì® <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞:</b>\n\n"
            
            for i, msg in enumerate(messages):
                if msg.text:
                    is_outgoing = "üü¢ –ò—Å—Ö–æ–¥—è—â–µ–µ" if msg.out else "üîµ –í—Ö–æ–¥—è—â–µ–µ"
                    debug_info += f"{i+1}. {is_outgoing}\n"
                    debug_info += f"   {msg.text[:100]}...\n\n"
                    
                    if not msg.out:  # –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        response_count += 1
            
            debug_info += f"\nüìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
            debug_info += f"‚Ä¢ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(messages)}\n"
            debug_info += f"‚Ä¢ –û—Ç–≤–µ—Ç–æ–≤ –æ—Ç –±–æ—Ç–∞: {response_count}\n"
            debug_info += f"‚Ä¢ –ò—Å—Ö–æ–¥—è—â–∏—Ö: {sum(1 for m in messages if m.out)}\n"
            
            if response_count > 0:
                debug_info += "\n‚úÖ <b>–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç!</b>"
                await utils.answer(message, self.strings("bot_responding"))
                await message.respond(debug_info, parse_mode='HTML')
            else:
                debug_info += "\n‚ùå <b>–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∏–ª–∏ –Ω–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</b>"
                await utils.answer(message, debug_info, parse_mode='HTML')
                
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
    
    @loader.command(
        ru_doc="–¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å –æ—Ç–ª–∞–¥–∫–æ–π",
        en_doc="Test parsing with debug"
    )
    async def testparsewithdebug(self, message):
        """–¢–µ—Å—Ç —Å –æ—Ç–ª–∞–¥–∫–æ–π"""
        await utils.answer(message, self.strings("parsing_debug"))
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã —Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            usd_price, ton_price, debug_info = await self._get_prices_with_debug()
            
            response_text = "üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞:</b>\n\n"
            
            if usd_price and ton_price:
                response_text += f"‚úÖ <b>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã!</b>\n\n"
                response_text += f"üíµ USD: {usd_price:.2f}‚ÇΩ\n"
                response_text += f"üíé TON: {ton_price:.2f}‚ÇΩ\n\n"
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç
                post = self._format_post(usd_price, ton_price)
                response_text += f"üìù <b>–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Å—Ç:</b>\n{post}\n\n"
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç
                await self.client.send_message(
                    self.target_channel,
                    post,
                    parse_mode='HTML'
                )
                
                response_text += "‚úÖ <b>–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª</b>"
            else:
                response_text += f"‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</b>\n\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            response_text += f"\nüîß <b>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n{debug_info}"
            
            await utils.answer(message, response_text, parse_mode='HTML')
                
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
    
    @loader.command(
        ru_doc="–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∏ –ø–æ—Å—Ç",
        en_doc="Simple test and post"
    )
    async def testandpost(self, message):
        """–¢–µ—Å—Ç –∏ –ø–æ—Å—Ç"""
        try:
            usd_price, ton_price = await self._get_prices_simple()
            
            if usd_price and ton_price:
                post = self._format_post(usd_price, ton_price)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
                await self.client.send_message(
                    self.target_channel,
                    post,
                    parse_mode='HTML'
                )
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º
                self.last_usd_price = usd_price
                self.last_ton_price = ton_price
                self.last_update = time.time()
                
                await utils.answer(message, self.strings("test_sent"))
                await message.respond(post, parse_mode='HTML')
            else:
                await utils.answer(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ò—Å–ø–æ–ª—å–∑—É–π .testparsewithdebug –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏")
                
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É",
        en_doc="Toggle debug mode"
    )
    async def toggledebug(self, message):
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É"""
        self.debug_mode = not self.debug_mode
        
        if self.debug_mode:
            await utils.answer(message, self.strings("debug_mode"))
            logger.info("–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤–∫–ª—é—á–µ–Ω")
        else:
            await utils.answer(message, self.strings("debug_off"))
            logger.info("–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω")
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å",
        en_doc="Status"
    )
    async def durovworkstatus(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç" if self.is_running else "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        last_time = "‚Äî"
        if self.last_update:
            last_time = self._get_msk_time_str(self.last_update)
        
        usd_info = f"{self.last_usd_price:.2f}‚ÇΩ" if self.last_usd_price else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        ton_info = f"{self.last_ton_price:.2f}‚ÇΩ" if self.last_ton_price else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        
        debug_state = "üü¢ –í–ö–õ" if self.debug_mode else "üî¥ –í–´–ö–õ"
        
        info = f"{self.strings('status').format(status, last_time, usd_info, ton_info)}\n\n"
        info += f"üîß <b>–û—Ç–ª–∞–¥–∫–∞:</b> {debug_state}\n"
        info += f"ü§ñ <b>–ë–æ—Ç:</b> @DurovKursBot\n"
        info += f"üì¢ <b>–ö–∞–Ω–∞–ª:</b> @priceDollarTon"
        
        await utils.answer(message, info, parse_mode='HTML')
    
    async def _working_loop(self):
        """–†–∞–±–æ—á–∏–π —Ü–∏–∫–ª"""
        logger.info("–†–∞–±–æ—á–∏–π —Ü–∏–∫–ª –∑–∞–ø—É—â–µ–Ω")
        
        while self.is_running:
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã (–ø—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ –±–µ–∑ –æ—Ç–ª–∞–¥–∫–∏)
                usd_price, ton_price = await self._get_prices_simple()
                
                if usd_price and ton_price:
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
                    self.last_usd_price = usd_price
                    self.last_ton_price = ton_price
                    self.last_update = time.time()
                    
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å—Ç
                    post = self._format_post(usd_price, ton_price)
                    
                    await self.client.send_message(
                        self.target_channel,
                        post,
                        parse_mode='HTML'
                    )
                    
                    logger.info(f"–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω | USD: {usd_price:.2f}‚ÇΩ, TON: {ton_price:.2f}‚ÇΩ")
                
                # –ñ–¥–µ–º 3 –º–∏–Ω—É—Ç—ã
                wait_time = 180
                for i in range(wait_time):
                    if not self.is_running:
                        break
                    await asyncio.sleep(1)
                    
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—á–µ–º —Ü–∏–∫–ª–µ: {e}")
                await asyncio.sleep(30)
    
    async def _get_prices_simple(self):
        """–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω (–¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ —Ü–∏–∫–ª–∞)"""
        try:
            # –û—á–∏—â–∞–µ–º —á–∞—Ç –∫–æ–º–∞–Ω–¥–æ–π, –∫–æ—Ç–æ—Ä–∞—è —Ç–æ—á–Ω–æ –¥–∞—Å—Ç –æ—Ç–≤–µ—Ç
            await self.client.send_message(self.source_bot, "/start")
            await asyncio.sleep(1)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã
            await self.client.send_message(self.source_bot, "1 usd")
            await asyncio.sleep(3)  # –î–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—Ç–≤–µ—Ç
            
            await self.client.send_message(self.source_bot, "1 ton")
            await asyncio.sleep(3)
            
            # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ)
            messages = await self.client.get_messages(self.source_bot, limit=20)
            
            usd_price = None
            ton_price = None
            
            # –ò—â–µ–º –ª—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –Ω—É–∂–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º msg.out)
            for msg in messages:
                if msg.text:
                    text = msg.text
                    
                    # –ò—â–µ–º USD
                    if not usd_price and "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 1.0 USDT" in text:
                        usd_price = self._extract_rub_price(text)
                    
                    # –ò—â–µ–º TON
                    if not ton_price and "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 1.0 TON" in text:
                        ton_price = self._extract_rub_price(text)
                    
                    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–∏—Å–∫–∏
                    if not usd_price and ("1 usd" in text.lower() or "1 usdt" in text.lower()):
                        usd_price = self._extract_any_price(text, "usd")
                    
                    if not ton_price and ("1 ton" in text.lower() or "1 —Ç–æ–Ω" in text.lower()):
                        ton_price = self._extract_any_price(text, "ton")
            
            return usd_price, ton_price
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω: {e}")
            return None, None
    
    async def _get_prices_with_debug(self):
        """–ú–µ—Ç–æ–¥ —Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"""
        debug_info = ""
        
        try:
            # –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞
            debug_info += "1. –û—Ç–ø—Ä–∞–≤–ª—è—é /start...\n"
            await self.client.send_message(self.source_bot, "/start")
            await asyncio.sleep(1)
            
            # –®–∞–≥ 2: –ó–∞–ø—Ä–æ—Å USD
            debug_info += "2. –û—Ç–ø—Ä–∞–≤–ª—è—é '1 usd'...\n"
            await self.client.send_message(self.source_bot, "1 usd")
            await asyncio.sleep(3)
            
            # –®–∞–≥ 3: –ó–∞–ø—Ä–æ—Å TON
            debug_info += "3. –û—Ç–ø—Ä–∞–≤–ª—è—é '1 ton'...\n"
            await self.client.send_message(self.source_bot, "1 ton")
            await asyncio.sleep(3)
            
            # –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
            debug_info += "4. –ü–æ–ª—É—á–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...\n"
            messages = await self.client.get_messages(self.source_bot, limit=15)
            
            debug_info += f"   ‚Ä¢ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(messages)}\n"
            
            usd_price = None
            ton_price = None
            found_responses = []
            
            for i, msg in enumerate(messages):
                if msg.text:
                    direction = "–ò–°–•–û–î–Ø–©–ï–ï" if msg.out else "–í–•–û–î–Ø–©–ï–ï"
                    preview = msg.text[:50].replace('\n', ' ')
                    
                    debug_info += f"   {i+1}. [{direction}] {preview}...\n"
                    found_responses.append(f"{i+1}. [{direction}] {preview}")
                    
                    # –ü–∞—Ä—Å–∏–Ω–≥
                    if "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 1.0 USDT" in msg.text and not usd_price:
                        usd_price = self._extract_rub_price(msg.text)
                        if usd_price:
                            debug_info += f"      ‚Üí –ù–∞–π–¥–µ–Ω USD: {usd_price}‚ÇΩ\n"
                    
                    if "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 1.0 TON" in msg.text and not ton_price:
                        ton_price = self._extract_rub_price(msg.text)
                        if ton_price:
                            debug_info += f"      ‚Üí –ù–∞–π–¥–µ–Ω TON: {ton_price}‚ÇΩ\n"
            
            debug_info += f"\n5. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n"
            debug_info += f"   ‚Ä¢ USD: {usd_price if usd_price else '–ù–µ –Ω–∞–π–¥–µ–Ω'}\n"
            debug_info += f"   ‚Ä¢ TON: {ton_price if ton_price else '–ù–µ –Ω–∞–π–¥–µ–Ω'}\n"
            
            return usd_price, ton_price, debug_info
            
        except Exception as e:
            debug_info += f"\n‚ùå –û—à–∏–±–∫–∞: {str(e)}"
            return None, None, debug_info
    
    def _extract_rub_price(self, text):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã RUB –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        try:
            # –ò—â–µ–º "RUB : —á–∏—Å–ª–æ" –∏–ª–∏ "RUB: —á–∏—Å–ª–æ"
            patterns = [
                r'RUB\s*:\s*([\d]+[.,]\d+)',
                r'RUB:\s*([\d]+[.,]\d+)',
                r'RUB\s*=\s*([\d]+[.,]\d+)',
                r'([\d]+[.,]\d+)\s*‚ÇΩ.*RUB',
                r'RUB.*?([\d]+[.,]\d+)\s*‚ÇΩ'
            ]
            
            for pattern in patterns:
                match = re.search(pattern, text, re.IGNORECASE)
                if match:
                    price_str = match.group(1).replace(',', '.')
                    price = float(price_str)
                    return round(price, 2)
            
            return None
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è RUB: {e}")
            return None
    
    def _extract_any_price(self, text, currency_type):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ª—é–±–æ–π —Ü–µ–Ω—ã"""
        try:
            # –ò—â–µ–º –ª—é–±–æ–µ —á–∏—Å–ª–æ —Å ‚ÇΩ –∏–ª–∏ —Ä—É–±
            pattern = r'(\d+[.,]\d+)\s*[‚ÇΩ—Ä—É–±]'
            matches = re.findall(pattern, text)
            
            for match in matches:
                price_str = match.replace(',', '.')
                price = float(price_str)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
                if currency_type.lower() == "usd":
                    if 30 <= price <= 150:
                        return round(price, 2)
                elif currency_type.lower() == "ton":
                    if 10 <= price <= 1000:
                        return round(price, 2)
            
            return None
        except:
            return None
    
    def _get_msk_time(self):
        """–í—Ä–µ–º—è –ú–°–ö"""
        utc_now = datetime.utcnow()
        return utc_now + timedelta(hours=3)
    
    def _get_msk_time_str(self, timestamp=None):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ú–°–ö"""
        if timestamp:
            utc_time = datetime.utcfromtimestamp(timestamp)
            msk_time = utc_time + timedelta(hours=3)
        else:
            msk_time = self._get_msk_time()
        
        return msk_time.strftime("%H:%M –ú–°–ö")
    
    def _format_number(self, number):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞"""
        if isinstance(number, (int, float)):
            formatted = f"{number:,.2f}".replace(".", ",")
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Å—è—Ç–∏—á–Ω–∞—è —á–∞—Å—Ç—å
            if "," in formatted:
                parts = formatted.split(",")
                parts[0] = parts[0].replace(",", " ")
                formatted = ",".join(parts)
            
            # –£–±–∏—Ä–∞–µ–º .00 –µ—Å–ª–∏ —Ü–µ–ª–æ–µ
            if formatted.endswith(",00"):
                formatted = formatted[:-3]
            
            return formatted
        return str(number)
    
    def _format_post(self, usd_price, ton_price):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞"""
        usd_formatted = self._format_number(usd_price)
        ton_formatted = self._format_number(ton_price)
        msk_time = self._get_msk_time_str()
        
        return f"üíµ USD: <b>{usd_formatted}‚ÇΩ</b>\nüíé TON: <b>{ton_formatted}‚ÇΩ</b>\n\n<i>üïê {msk_time} | @priceDollarTon</i>"
    
    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞"""
        self.is_running = False
        if self.task:
            self.task.cancel()
